<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Choferes y Camiones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-bg: #1f2937;
            --light-bg: #f9fafb;
            --border-color: #e5e7eb;
            --text-dark: #111827;
            --text-light: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            font-size: 14px;
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .menu-item {
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .menu-item .icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: var(--text-dark);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.blue { background: #dbeafe; }
        .stat-icon.green { background: #d1fae5; }
        .stat-icon.yellow { background: #fef3c7; }
        .stat-icon.red { background: #fee2e2; }

        .stat-info h3 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Content Card */
        .content-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--light-bg);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: var(--light-bg);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-dark);
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Alert Box */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Document Upload */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--light-bg);
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background: #dbeafe;
        }

        /* Document List */
        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--light-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Language Selector */
        .language-selector {
            margin-top: auto;
            padding-top: 20px;
        }

        .language-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }

        .language-selector select option {
            color: var(--text-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light-bg);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* Back Button */
        .back-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            color: var(--secondary-color);
            transform: translateX(-3px);
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none !important;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            text-align: center;
            font-size: 48px;
            margin-bottom: 10px;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--text-dark);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input,
        .login-form select {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
        }

        .login-form input:focus,
        .login-form select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--text-light);
            font-size: 14px;
        }

        .login-footer a {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        /* User Menu */
        .user-menu {
            padding: 20px 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* Details View */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 16px;
            color: var(--text-dark);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div id="company-logo-login" class="login-logo">üöõ</div>
            <div class="login-title" id="login-title">Fleet Manager</div>
            <div style="text-align: center; color: var(--text-light); font-size: 14px; margin-bottom: 20px;" id="company-name-login">
                Sistema de Gesti√≥n
            </div>
            
            <form class="login-form" id="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="login-username" placeholder="Usuario" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" required>
                <button type="submit" class="login-btn" id="login-btn">Iniciar Sesi√≥n</button>
            </form>

            <!-- Progress Bar -->
            <div id="progress-container" style="display: none; margin-top: 20px;">
                <div style="background: #e5e7eb; border-radius: 8px; overflow: hidden; height: 30px;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #2563eb, #10b981); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;">
                        0%
                    </div>
                </div>
                <div id="progress-text" style="text-align: center; margin-top: 10px; font-size: 14px; color: #6b7280;">
                    Iniciando...
                </div>
            </div>

            <div class="login-footer" style="color: var(--text-light); font-size: 12px;">
                <span id="default-credentials-hint"></span>
            </div>
        </div>
    </div>

    <div class="container" id="main-app" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div id="company-logo-sidebar" class="logo">üöõ Fleet Manager</div>
            <div class="subtitle" id="company-subtitle">
                Sistema de Gesti√≥n
            </div>
            
            <div class="menu-item active" onclick="showSection('dashboard')">
                <span class="icon">üìä</span>
                <span id="menu-dashboard">Dashboard</span>
            </div>
            <div class="menu-item" onclick="showSection('drivers')">
                <span class="icon">üë§</span>
                <span id="menu-drivers">Choferes</span>
            </div>
            <div class="menu-item" onclick="showSection('trucks')">
                <span class="icon">üöõ</span>
                <span id="menu-trucks">Camiones</span>
            </div>
            <div class="menu-item" onclick="showSection('assignments')">
                <span class="icon">üîó</span>
                <span id="menu-assignments">Asignaciones</span>
            </div>
            <div class="menu-item" onclick="showSection('trips')">
                <span class="icon">üöö</span>
                <span id="menu-trips">Viajes</span>
            </div>
            <div class="menu-item" onclick="showSection('documents')">
                <span class="icon">üìÅ</span>
                <span id="menu-documents">Documentos</span>
            </div>
            <div class="menu-item" onclick="showSection('brokers')">
                <span class="icon">ü§ù</span>
                <span id="menu-brokers">Brokers & Dispatch</span>
            </div>
            <div class="menu-item" onclick="showSection('invoices')">
                <span class="icon">üßæ</span>
                <span id="menu-invoices">Facturas</span>
            </div>
            <div class="menu-item" onclick="showSection('expenses')">
                <span class="icon">üí∏</span>
                <span id="menu-expenses">Gastos</span>
            </div>
            <div class="menu-item" onclick="showSection('accounting')">
                <span class="icon">üìä</span>
                <span id="menu-accounting">Contabilidad</span>
            </div>
            <div class="menu-item" onclick="showSection('company')">
                <span class="icon">üè¢</span>
                <span id="menu-company">Empresa</span>
            </div>
            <div class="menu-item" onclick="showSection('reports')">
                <span class="icon">üìà</span>
                <span id="menu-reports">Reportes</span>
            </div>

            <div class="user-menu">
                <div class="user-info" onclick="showUserProfile()" style="cursor: pointer;">
                    <div class="user-avatar" id="user-avatar">üë§</div>
                    <div class="user-details">
                        <div class="user-name" id="user-name">Usuario</div>
                        <div class="user-role-display" id="user-role-display">Admin</div>
                    </div>
                </div>
                <button class="menu-item" onclick="handleLogout()" style="width: 100%; border: none; background: none; color: white; text-align: left;">
                    <span class="icon">üö™</span>
                    <span id="menu-logout">Cerrar Sesi√≥n</span>
                </button>
            </div>

            <div class="language-selector">
                <select id="languageSelector" onchange="changeLanguage()">
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="en">üá∫üá∏ English</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <div class="header">
                    <h1 id="title-dashboard">Dashboard</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">üë•</div>
                        <div class="stat-info">
                            <h3 id="stat-drivers">0</h3>
                            <p id="label-total-drivers">Total de Choferes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">üöõ</div>
                        <div class="stat-info">
                            <h3 id="stat-trucks">0</h3>
                            <p id="label-total-trucks">Total de Camiones</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon yellow">‚úì</div>
                        <div class="stat-info">
                            <h3 id="stat-available">0</h3>
                            <p id="label-available-trucks">Camiones Disponibles</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon red">üìÑ</div>
                        <div class="stat-info">
                            <h3 id="stat-pending">0</h3>
                            <p id="label-pending-docs">Documentos Pendientes</p>
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <h2 id="label-expiring-soon">‚ö†Ô∏è Vencimientos Pr√≥ximos</h2>
                    <div id="expiring-list" style="margin-top: 20px;">
                        <div class="alert alert-success">
                            <span id="no-alerts">‚úÖ No hay documentos pr√≥ximos a vencer</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drivers Section -->
            <div id="drivers-section" class="section hidden">
                <div class="header">
                    <h1 id="title-drivers">üë§ Choferes</h1>
                    <button class="btn btn-primary" onclick="openDriverModal()">
                        <span>‚ûï</span>
                        <span id="btn-add-driver">Agregar Chofer</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="driver-search" placeholder="Buscar por nombre, licencia..." onkeyup="searchDrivers()">
                        <button class="btn btn-primary" onclick="searchDrivers()">
                            <span>üîç</span>
                            <span id="btn-search">Buscar</span>
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="drivers-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-name">Nombre</th>
                                    <th id="th-license">Licencia</th>
                                    <th id="th-phone">Tel√©fono</th>
                                    <th id="th-email">Email</th>
                                    <th id="th-status">Estado</th>
                                    <th id="th-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="drivers-tbody">
                                <!-- Drivers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Trucks Section -->
            <div id="trucks-section" class="section hidden">
                <div class="header">
                    <h1 id="title-trucks">üöõ Camiones</h1>
                    <button class="btn btn-primary" onclick="openTruckModal()">
                        <span>‚ûï</span>
                        <span id="btn-add-truck">Agregar Cami√≥n</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="truck-search" placeholder="Buscar por n√∫mero, placa..." onkeyup="searchTrucks()">
                        <button class="btn btn-primary" onclick="searchTrucks()">üîç <span id="btn-search-truck">Buscar</span></button>
                    </div>

                    <div class="table-container">
                        <table id="trucks-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-truck-number">N√∫mero</th>
                                    <th id="th-plate">Placa</th>
                                    <th id="th-brand">Marca/Modelo</th>
                                    <th id="th-year">A√±o</th>
                                    <th id="th-truck-status">Estado</th>
                                    <th id="th-truck-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="trucks-tbody">
                                <!-- Trucks will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Assignments Section -->
            <div id="assignments-section" class="section hidden">
                <div class="header">
                    <h1 id="title-assignments">üîó Asignaciones</h1>
                    <button class="btn btn-primary" onclick="openAssignmentModal()">
                        <span>‚ûï</span>
                        <span id="btn-new-assignment">Nueva Asignaci√≥n</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-driver">Chofer</th>
                                    <th id="th-truck">Cami√≥n</th>
                                    <th id="th-assignment-date">Fecha Asignaci√≥n</th>
                                    <th id="th-end-date">Fecha Fin</th>
                                    <th id="th-assignment-status">Estado</th>
                                    <th id="th-assignment-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignments-tbody">
                                <!-- Assignments will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Trips Section -->
            <div id="trips-section" class="section hidden">
                <div class="header">
                    <h1>üöö <span id="title-trips">Viajes</span></h1>
                    <button class="btn btn-primary" onclick="openTripModal()">
                        <span>‚ûï</span>
                        <span id="btn-new-trip">Nuevo Viaje</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-trip-driver">Chofer</th>
                                    <th id="th-trip-document">Documento/Carga</th>
                                    <th id="th-trip-pickup">Recogida</th>
                                    <th id="th-trip-destination">Destino</th>
                                    <th id="th-trip-distance">Distancia</th>
                                    <th id="th-trip-status">Estado</th>
                                    <th id="th-trip-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="trips-tbody">
                                <!-- Trips will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <div id="documents-section" class="section hidden">
                <div class="header">
                    <h1 id="title-documents">üìÅ Documentos</h1>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="openSendDocumentsModal()">
                            <span>üì§</span>
                            <span id="btn-send-docs">Enviar a Broker</span>
                        </button>
                        <button class="btn btn-primary" onclick="openDocumentModal()">
                            <span>‚ûï</span>
                            <span id="btn-upload-doc">Subir Documento</span>
                        </button>
                    </div>
                </div>

                <div class="content-card">
                    <div class="tabs">
                        <button class="tab active" onclick="filterDocuments('all')" id="tab-all">Todos</button>
                        <button class="tab" onclick="filterDocuments('pending')" id="tab-pending">Pendientes</button>
                        <button class="tab" onclick="filterDocuments('approved')" id="tab-approved">Aprobados</button>
                        <button class="tab" onclick="filterDocuments('rejected')" id="tab-rejected">Rechazados</button>
                    </div>

                    <div id="documents-list">
                        <!-- Documents will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Brokers & Dispatch Section -->
            <div id="brokers-section" class="section hidden">
                <div class="header">
                    <h1 id="title-brokers">ü§ù Brokers & Dispatch</h1>
                    <button class="btn btn-primary" onclick="openBrokerModal()">
                        <span>‚ûï</span>
                        <span id="btn-add-broker">Agregar Broker/Dispatch</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="broker-search" placeholder="Buscar por nombre, compa√±√≠a, email..." onkeyup="searchBrokers()">
                        <button class="btn btn-primary" onclick="searchBrokers()">
                            <span>üîç</span>
                            <span id="btn-search-broker">Buscar</span>
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="brokers-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-broker-type">Tipo</th>
                                    <th id="th-broker-company">Compa√±√≠a</th>
                                    <th id="th-broker-contact">Contacto</th>
                                    <th id="th-broker-email">Email</th>
                                    <th id="th-broker-phone">Tel√©fono</th>
                                    <th id="th-broker-status">Estado</th>
                                    <th id="th-broker-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="brokers-tbody">
                                <!-- Brokers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Company Section -->
            <!-- Invoices Section -->
            <div id="invoices-section" class="section hidden">
                <div class="header">
                    <h1>üßæ <span id="title-invoices">Facturas</span></h1>
                    <button class="btn btn-primary" onclick="openInvoiceModal()">‚ûï Nueva Factura</button>
                </div>
                <div class="content-card">
                    <!-- Summary Cards -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">COBRADAS</div>
                            <div style="font-size:24px;font-weight:bold;" id="inv-paid">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">PENDIENTES</div>
                            <div style="font-size:24px;font-weight:bold;" id="inv-pending">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">VENCIDAS</div>
                            <div style="font-size:24px;font-weight:bold;" id="inv-overdue">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">TOTAL</div>
                            <div style="font-size:24px;font-weight:bold;" id="inv-total">$0.00</div>
                        </div>
                    </div>
                    <!-- Filter Tabs -->
                    <div class="tabs" style="margin-bottom:15px;">
                        <button class="tab active" onclick="filterInvoices('all')" id="inv-tab-all">Todas</button>
                        <button class="tab" onclick="filterInvoices('pending')" id="inv-tab-pending">Pendientes</button>
                        <button class="tab" onclick="filterInvoices('paid')" id="inv-tab-paid">Cobradas</button>
                        <button class="tab" onclick="filterInvoices('overdue')" id="inv-tab-overdue">Vencidas</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th># Factura</th>
                                    <th>Cliente</th>
                                    <th>Viaje</th>
                                    <th>Fecha</th>
                                    <th>Vencimiento</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses-section" class="section hidden">
                <div class="header">
                    <h1>üí∏ <span id="title-expenses">Gastos</span></h1>
                    <button class="btn btn-primary" onclick="openExpenseModal()">‚ûï Nuevo Gasto</button>
                </div>
                <div class="content-card">
                    <!-- Summary -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">ESTE MES</div>
                            <div style="font-size:24px;font-weight:bold;" id="exp-month">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">ESTE A√ëO</div>
                            <div style="font-size:24px;font-weight:bold;" id="exp-year">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#374151,#1f2937);color:white;padding:20px;border-radius:12px;text-align:center;">
                            <div style="font-size:12px;opacity:0.9;">TOTAL</div>
                            <div style="font-size:24px;font-weight:bold;" id="exp-total">$0.00</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Categor√≠a</th>
                                    <th>Descripci√≥n</th>
                                    <th>Cami√≥n/Chofer</th>
                                    <th>Monto</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Accounting Section -->
            <div id="accounting-section" class="section hidden">
                <div class="header">
                    <h1>üìä <span id="title-accounting">Contabilidad</span></h1>
                    <button class="btn btn-success" onclick="exportAccounting()">üì• Exportar</button>
                </div>
                <div class="content-card">
                    <!-- Balance General -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px;">
                        <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:25px;border-radius:12px;text-align:center;">
                            <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">üí∞ INGRESOS TOTALES</div>
                            <div style="font-size:32px;font-weight:bold;" id="acc-income">$0.00</div>
                        </div>
                        <div style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;padding:25px;border-radius:12px;text-align:center;">
                            <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">üí∏ GASTOS TOTALES</div>
                            <div style="font-size:32px;font-weight:bold;" id="acc-expenses">$0.00</div>
                        </div>
                        <div style="padding:25px;border-radius:12px;text-align:center;border:3px solid var(--primary-color);" id="acc-balance-card">
                            <div style="font-size:14px;color:var(--text-light);margin-bottom:8px;">üìà BALANCE NETO</div>
                            <div style="font-size:32px;font-weight:bold;" id="acc-balance">$0.00</div>
                        </div>
                    </div>
                    <!-- Gastos por Categor√≠a -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <div>
                            <h3 style="margin-bottom:15px;">üí∏ Gastos por Categor√≠a</h3>
                            <div id="expenses-by-category"></div>
                        </div>
                        <div>
                            <h3 style="margin-bottom:15px;">üßæ √öltimas Facturas</h3>
                            <div id="recent-invoices-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="company-section" class="section hidden">
                <div class="header">
                    <h1 id="title-company">üè¢ Informaci√≥n de la Empresa</h1>
                    <button class="btn btn-success" onclick="saveCompanyInfo()">
                        <span>üíæ</span>
                        <span id="btn-save-company">Guardar Cambios</span>
                    </button>
                </div>

                <div class="content-card">
                    <form id="company-form">
                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üè¢</span>
                                <span id="section-company-basic">Informaci√≥n B√°sica</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label id="label-company-name">Nombre de la Empresa *</label>
                                    <input type="text" id="company-name" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-legal-name">Nombre Legal</label>
                                    <input type="text" id="company-legal-name">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-tax-id">Tax ID / EIN *</label>
                                    <input type="text" id="company-tax-id" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-mc">MC Number</label>
                                    <input type="text" id="company-mc-number">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-dot">DOT Number</label>
                                    <input type="text" id="company-dot-number">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-usdot">USDOT Number</label>
                                    <input type="text" id="company-usdot">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üìû</span>
                                <span id="section-company-contact">Informaci√≥n de Contacto</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label id="label-company-phone">Tel√©fono Principal *</label>
                                    <input type="tel" id="company-phone" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-phone2">Tel√©fono Secundario</label>
                                    <input type="tel" id="company-phone2">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-email">Email *</label>
                                    <input type="email" id="company-email" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-website">Sitio Web</label>
                                    <input type="url" id="company-website" placeholder="https://">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-fax">Fax</label>
                                    <input type="tel" id="company-fax">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üìç</span>
                                <span id="section-company-address">Direcci√≥n</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label id="label-company-address">Direcci√≥n *</label>
                                    <input type="text" id="company-address" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-city">Ciudad *</label>
                                    <input type="text" id="company-city" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-state">Estado/Provincia *</label>
                                    <input type="text" id="company-state" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-zip">C√≥digo Postal *</label>
                                    <input type="text" id="company-zip" required>
                                </div>
                                <div class="form-group">
                                    <label id="label-company-country">Pa√≠s *</label>
                                    <input type="text" id="company-country" value="USA" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üñºÔ∏è</span>
                                <span id="section-company-logo">Logo de la Empresa</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label id="label-company-logo">Logo (Imagen)</label>
                                    <div style="display: flex; gap: 20px; align-items: center;">
                                        <div id="logo-preview" style="width: 150px; height: 150px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; background: var(--light-bg); overflow: hidden;">
                                            <span style="color: var(--text-light); font-size: 48px;" id="logo-placeholder">üè¢</span>
                                            <img id="logo-image" src="" alt="Logo" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                                        </div>
                                        <div style="flex: 1;">
                                            <input type="file" id="company-logo-upload" accept="image/*" style="display: none;" onchange="previewLogo(event)">
                                            <button type="button" class="btn btn-primary" onclick="document.getElementById('company-logo-upload').click()">
                                                <span>üìÅ</span>
                                                <span id="btn-upload-logo">Subir Logo</span>
                                            </button>
                                            <p style="margin-top: 10px; font-size: 12px; color: var(--text-light);" id="logo-help">
                                                Formatos: JPG, PNG, GIF. Tama√±o recomendado: 300x300px
                                            </p>
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeLogo()" style="margin-top: 10px;">
                                                <span>üóëÔ∏è</span>
                                                <span id="btn-remove-logo">Eliminar Logo</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üìÑ</span>
                                <span id="section-company-additional">Informaci√≥n Adicional</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label id="label-company-founded">A√±o de Fundaci√≥n</label>
                                    <input type="number" id="company-founded" min="1900" max="2030">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-employees">N√∫mero de Empleados</label>
                                    <input type="number" id="company-employees">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-fleet-size">Tama√±o de Flota</label>
                                    <input type="number" id="company-fleet-size">
                                </div>
                                <div class="form-group">
                                    <label id="label-company-currency">Moneda</label>
                                    <select id="company-currency">
                                        <option value="USD">USD - D√≥lar</option>
                                        <option value="MXN">MXN - Peso Mexicano</option>
                                        <option value="CAD">CAD - D√≥lar Canadiense</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label id="label-company-description">Descripci√≥n</label>
                                    <textarea id="company-description" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section hidden">
                <div class="header">
                    <h1 id="title-reports">üìà Reportes</h1>
                </div>

                <div class="content-card">
                    <h3 id="label-generate-reports">Generar Reportes</h3>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <button class="btn btn-primary" style="height: 100px; flex-direction: column;" onclick="generateReport('drivers')">
                            <span style="font-size: 32px;">üë•</span>
                            <span id="report-drivers">Reporte de Choferes</span>
                        </button>
                        <button class="btn btn-primary" style="height: 100px; flex-direction: column;" onclick="generateReport('trucks')">
                            <span style="font-size: 32px;">üöõ</span>
                            <span id="report-trucks">Reporte de Camiones</span>
                        </button>
                        <button class="btn btn-primary" style="height: 100px; flex-direction: column;" onclick="generateReport('assignments')">
                            <span style="font-size: 32px;">üîó</span>
                            <span id="report-assignments">Reporte de Asignaciones</span>
                        </button>
                        <button class="btn btn-primary" style="height: 100px; flex-direction: column;" onclick="generateReport('documents')">
                            <span style="font-size: 32px;">üìÑ</span>
                            <span id="report-documents">Reporte de Documentos</span>
                        </button>
                    </div>
                        <div class="form-section">
                            <div class="form-section-title">
                                <span>üé®</span>
                                <span id="section-company-theme">Tema y Color</span>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label id="label-theme-color">Color del Tema</label>
                                    <select id="theme-color" onchange="changeTheme()" style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px;">
                                        <option value="blue">üîµ Azul (Por defecto)</option>
                                        <option value="green">üü¢ Verde</option>
                                        <option value="purple">üü£ Morado</option>
                                        <option value="red">üî¥ Rojo</option>
                                        <option value="orange">üü† Naranja</option>
                                        <option value="teal">üü¶ Turquesa</option>
                                        <option value="dark">‚ö´ Oscuro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label id="label-theme-preview">Vista Previa</label>
                                    <div style="padding:20px;background:var(--primary-color);color:white;border-radius:8px;text-align:center;font-weight:bold;">
                                        Color Principal
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Users Section (Admin Only) -->
            <div id="users-section" class="section hidden">
                <div class="header">
                    <h1 id="title-users">üë• Usuarios</h1>
                    <button class="btn btn-primary" onclick="openUserModal()">
                        <span>‚ûï</span>
                        <span id="btn-add-user">Agregar Usuario</span>
                    </button>
                </div>

                <div class="content-card">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="user-search" placeholder="Buscar por nombre, usuario, email..." onkeyup="searchUsers()">
                        <button class="btn btn-primary" onclick="searchUsers()">
                            <span>üîç</span>
                            <span id="btn-search-user">Buscar</span>
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th id="th-user-name">Nombre</th>
                                    <th id="th-user-username">Usuario</th>
                                    <th id="th-user-email">Email</th>
                                    <th id="th-user-role">Rol</th>
                                    <th id="th-user-status">Estado</th>
                                    <th id="th-user-actions">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Interface (Special View for Drivers) -->
    <div id="driver-app" style="display: none; min-height: 100vh; background: var(--light-bg);">
        <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
            <!-- Header para Chofer -->
            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 30px 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üë®‚Äç‚úàÔ∏è
                    </div>
                    <div>
                        <h2 id="driver-name" style="margin: 0; font-size: 24px;">Chofer</h2>
                        <p id="driver-role" style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Conductor</p>
                    </div>
                </div>
                <button onclick="handleLogout()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    üö™ <span id="driver-logout">Cerrar Sesi√≥n</span>
                </button>
            </div>

            <!-- Mi Informaci√≥n -->
            <div class="content-card" style="margin-bottom: 20px;">
                <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <span>üë§</span>
                    <span id="driver-my-info">Mi Informaci√≥n</span>
                </h3>
                <div id="driver-info-content" style="display: grid; gap: 15px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Subir Documentos -->
            <div class="content-card">
                <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <span>üì§</span>
                    <span id="driver-upload-docs">Subir Documentos</span>
                </h3>
                
                <!-- Tipo de Documento -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="driver-doc-type-label">
                        Tipo de Documento *
                    </label>
                    <select id="driver-doc-type" onchange="toggleBOLFields()" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;">
                        <option value="">Seleccionar...</option>
                        <option value="factura">üìÑ Factura / Invoice</option>
                        <option value="bill">üßæ Bill of Lading (BOL)</option>
                        <option value="recibo">üßæ Recibo / Receipt</option>
                        <option value="licencia">üöó Licencia</option>
                        <option value="medico">üè• Certificado M√©dico</option>
                        <option value="otro">üìã Otro</option>
                    </select>
                </div>

                <!-- Campos espec√≠ficos para BOL -->
                <div id="bol-fields" style="display: none; margin-bottom: 20px; padding: 15px; background: #eff6ff; border-left: 4px solid #2563eb; border-radius: 8px;">
                    <h4 style="margin: 0 0 15px 0; color: #1e40af;">üìç Informaci√≥n del Viaje</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Origen *</label>
                        <input type="text" id="bol-origin" placeholder="Ej: Los Angeles, CA" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Destino *</label>
                        <input type="text" id="bol-destination" placeholder="Ej: Dallas, TX" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">N√∫mero de BOL</label>
                        <input type="text" id="bol-number" placeholder="Ej: BOL-12345" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Carga</label>
                        <input type="text" id="bol-cargo" placeholder="Descripci√≥n de la carga" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                    </div>
                </div>

                <!-- Nombre del Documento -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="driver-doc-name-label">
                        Nombre del Documento
                    </label>
                    <input type="text" id="driver-doc-name" placeholder="Ej: Factura Gasolina, BOL #12345" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;">
                </div>

                <!-- Captura con C√°mara -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="driver-camera-label">
                        Tomar Foto con C√°mara
                    </label>
                    <input type="file" id="driver-camera-input" accept="image/*" capture="environment" style="display: none;">
                    <button onclick="openCamera()" style="width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 24px;">üì∑</span>
                        <span id="driver-take-photo">Tomar Foto</span>
                    </button>
                </div>

                <!-- O Seleccionar Archivo -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="driver-file-label">
                        O Seleccionar Archivo
                    </label>
                    <input type="file" id="driver-file-input" accept="image/*,.pdf" style="display: none;">
                    <button onclick="selectFile()" style="width: 100%; padding: 15px; background: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 24px;">üìÅ</span>
                        <span id="driver-select-file">Seleccionar Archivo</span>
                    </button>
                </div>

                <!-- Vista Previa -->
                <div id="driver-preview" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="driver-preview-label">
                        Vista Previa
                    </label>
                    <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center;">
                        <img id="driver-preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        <p id="driver-preview-name" style="margin: 10px 0 0 0; font-size: 14px; color: var(--text-light);"></p>
                    </div>
                    <button onclick="clearPreview()" style="margin-top: 10px; padding: 8px 16px; background: var(--danger-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        üóëÔ∏è <span id="driver-clear">Eliminar</span>
                    </button>
                </div>

                <!-- Bot√≥n Enviar -->
                <button onclick="uploadDriverDocument()" style="width: 100%; padding: 15px; background: var(--success-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">‚úÖ</span>
                    <span id="driver-submit">Enviar Documento</span>
                </button>
            </div>

            <!-- Mis Documentos Subidos -->
            <div class="content-card" style="margin-top: 20px;">
                <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <span>üìã</span>
                    <span id="driver-my-docs">Mis Documentos Subidos</span>
                </h3>
                <div id="driver-documents-list">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Documentos Recibidos del Admin -->
            <div class="content-card" style="margin-top: 20px;">
                <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <span>üì¨</span>
                    <span id="driver-received-docs">Documentos Recibidos</span>
                </h3>
                <div id="driver-received-documents-list">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- Mis Viajes Asignados -->
            <div class="content-card" style="margin-top: 20px;">
                <h3 style="margin: 0 0 20px 0; display: flex; align-items: center; gap: 10px;">
                    <span>üó∫Ô∏è</span>
                    <span id="driver-trips">Mis Viajes</span>
                </h3>
                <div id="driver-trips-list">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Modal -->
    <div id="driver-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeDriverModal()">‚Üê <span id="back-driver">Volver</span></button>
                <h2 id="modal-title-driver">Agregar Chofer</h2>
                <button class="close-btn" onclick="closeDriverModal()">&times;</button>
            </div>

            <form id="driver-form" onsubmit="saveDriver(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìã</span>
                        <span id="section-personal-info">Informaci√≥n Personal</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-first-name">Nombre *</label>
                            <input type="text" id="driver-first-name" required>
                        </div>
                        <div class="form-group">
                            <label id="label-last-name">Apellido *</label>
                            <input type="text" id="driver-last-name" required>
                        </div>
                        <div class="form-group">
                            <label id="label-phone">Tel√©fono *</label>
                            <input type="tel" id="driver-phone" required>
                        </div>
                        <div class="form-group">
                            <label id="label-email">Email</label>
                            <input type="email" id="driver-email">
                        </div>
                        <div class="form-group">
                            <label id="label-dob">Fecha de Nacimiento</label>
                            <input type="date" id="driver-dob">
                        </div>
                        <div class="form-group">
                            <label id="label-hire-date">Fecha de Contrataci√≥n</label>
                            <input type="date" id="driver-hire-date">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìç</span>
                        <span id="section-address">Direcci√≥n</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label id="label-address">Direcci√≥n</label>
                            <input type="text" id="driver-address">
                        </div>
                        <div class="form-group">
                            <label id="label-city">Ciudad</label>
                            <input type="text" id="driver-city">
                        </div>
                        <div class="form-group">
                            <label id="label-state">Estado/Provincia</label>
                            <input type="text" id="driver-state">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üöó</span>
                        <span id="section-license">Licencia</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-license-number">N√∫mero de Licencia *</label>
                            <input type="text" id="driver-license" required>
                        </div>
                        <div class="form-group">
                            <label id="label-license-type">Tipo de Licencia</label>
                            <select id="driver-license-type">
                                <option value="">Seleccionar...</option>
                                <option value="CDL-A">CDL-A</option>
                                <option value="CDL-B">CDL-B</option>
                                <option value="CDL-C">CDL-C</option>
                                <option value="Clase A">Clase A</option>
                                <option value="Clase B">Clase B</option>
                                <option value="Clase C">Clase C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-license-expiry">Vencimiento de Licencia</label>
                            <input type="date" id="driver-license-expiry">
                        </div>
                        <div class="form-group">
                            <label id="label-medical-cert">Venc. Certificado M√©dico</label>
                            <input type="date" id="driver-medical-cert">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üÜò</span>
                        <span id="section-emergency">Contacto de Emergencia</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-emergency-name">Nombre</label>
                            <input type="text" id="driver-emergency-name">
                        </div>
                        <div class="form-group">
                            <label id="label-emergency-phone">Tel√©fono</label>
                            <input type="tel" id="driver-emergency-phone">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label id="label-driver-status">Estado *</label>
                        <select id="driver-status" required>
                            <option value="active" id="status-active">Activo</option>
                            <option value="inactive" id="status-inactive">Inactivo</option>
                            <option value="suspended" id="status-suspended">Suspendido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-notes">Notas</label>
                        <textarea id="driver-notes"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeDriverModal()" id="btn-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Truck Modal -->
    <div id="truck-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeTruckModal()">‚Üê <span id="back-truck">Volver</span></button>
                <h2 id="modal-title-truck">Agregar Cami√≥n</h2>
                <button class="close-btn" onclick="closeTruckModal()">&times;</button>
            </div>

            <form id="truck-form" onsubmit="saveTruck(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üöõ</span>
                        <span id="section-truck-info">Informaci√≥n del Veh√≠culo</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-truck-number">N√∫mero de Cami√≥n *</label>
                            <input type="text" id="truck-number" required>
                        </div>
                        <div class="form-group">
                            <label id="label-plate-number">N√∫mero de Placa *</label>
                            <input type="text" id="truck-plate" required>
                        </div>
                        <div class="form-group">
                            <label>VIN *</label>
                            <input type="text" id="truck-vin" required>
                        </div>
                        <div class="form-group">
                            <label id="label-truck-make">Marca *</label>
                            <input type="text" id="truck-make" required>
                        </div>
                        <div class="form-group">
                            <label id="label-truck-model">Modelo *</label>
                            <input type="text" id="truck-model" required>
                        </div>
                        <div class="form-group">
                            <label id="label-truck-year">A√±o *</label>
                            <input type="number" id="truck-year" min="1900" max="2030" required>
                        </div>
                        <div class="form-group">
                            <label id="label-truck-color">Color</label>
                            <input type="text" id="truck-color">
                        </div>
                        <div class="form-group">
                            <label id="label-truck-type">Tipo</label>
                            <select id="truck-type">
                                <option value="">Seleccionar...</option>
                                <option value="Tractor">Tractor</option>
                                <option value="Volteo">Volteo</option>
                                <option value="Caja seca">Caja seca</option>
                                <option value="Refrigerado">Refrigerado</option>
                                <option value="Plataforma">Plataforma</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üîß</span>
                        <span id="section-maintenance">Mantenimiento</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-current-mileage">Kilometraje Actual</label>
                            <input type="number" id="truck-mileage">
                        </div>
                        <div class="form-group">
                            <label id="label-last-service">√öltimo Servicio</label>
                            <input type="date" id="truck-last-service">
                        </div>
                        <div class="form-group">
                            <label id="label-next-service">Pr√≥ximo Servicio</label>
                            <input type="date" id="truck-next-service">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìã</span>
                        <span id="section-insurance">Seguro e Inspecciones</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-insurance-expiry">Venc. Seguro</label>
                            <input type="date" id="truck-insurance-expiry">
                        </div>
                        <div class="form-group">
                            <label id="label-inspection-expiry">Venc. Inspecci√≥n</label>
                            <input type="date" id="truck-inspection-expiry">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label id="label-truck-status">Estado *</label>
                        <select id="truck-status" required>
                            <option value="available" id="truck-status-available">Disponible</option>
                            <option value="assigned" id="truck-status-assigned">Asignado</option>
                            <option value="maintenance" id="truck-status-maintenance">En Mantenimiento</option>
                            <option value="out-of-service" id="truck-status-out">Fuera de Servicio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-truck-notes">Notas</label>
                        <textarea id="truck-notes"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeTruckModal()" id="btn-truck-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-truck-save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeAssignmentModal()">‚Üê <span id="back-assignment">Volver</span></button>
                <h2 id="modal-title-assignment">Nueva Asignaci√≥n</h2>
                <button class="close-btn" onclick="closeAssignmentModal()">&times;</button>
            </div>

            <form id="assignment-form" onsubmit="saveAssignment(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üöõ</span>
                        <span id="section-assignment-basic">Asignaci√≥n B√°sica</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-select-driver">Seleccionar Chofer *</label>
                            <select id="assignment-driver" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-select-truck">Seleccionar Cami√≥n *</label>
                            <select id="assignment-truck" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-start-date">Fecha de Inicio *</label>
                            <input type="date" id="assignment-start-date" required>
                        </div>
                        <div class="form-group">
                            <label id="label-end-date">Fecha de Fin</label>
                            <input type="date" id="assignment-end-date">
                        </div>
                        <div class="form-group">
                            <label id="label-assignment-notes">Notas</label>
                            <textarea id="assignment-notes" placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeAssignmentModal()" id="btn-assignment-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-assignment-save">üíæ Asignar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeInvoiceModal()">‚Üê Volver</button>
                <h2>üßæ Nueva Factura</h2>
                <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <form id="invoice-form" onsubmit="saveInvoice(event)">
                <div class="form-section">
                    <div class="form-section-title"><span>üìã</span><span>Informaci√≥n de la Factura</span></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label># Factura *</label>
                            <input type="text" id="inv-number" placeholder="INV-0001" required>
                        </div>
                        <div class="form-group">
                            <label>Cliente *</label>
                            <input type="text" id="inv-client" placeholder="Nombre del cliente" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Factura *</label>
                            <select id="inv-type" required style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Seleccionar...</option>
                                <option value="trip">Por Viaje</option>
                                <option value="monthly">Mensual</option>
                                <option value="other">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Viaje Relacionado</label>
                            <select id="inv-trip" style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Sin viaje espec√≠fico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Emisi√≥n *</label>
                            <input type="date" id="inv-date" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Vencimiento *</label>
                            <input type="date" id="inv-due-date" required>
                        </div>
                        <div class="form-group">
                            <label>Monto (USD) *</label>
                            <input type="number" id="inv-amount" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n *</label>
                            <textarea id="inv-description" placeholder="Descripci√≥n del servicio..." required></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeInvoiceModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">üíæ Guardar Factura</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeExpenseModal()">‚Üê Volver</button>
                <h2>üí∏ Nuevo Gasto</h2>
                <button class="close-btn" onclick="closeExpenseModal()">&times;</button>
            </div>
            <form id="expense-form" onsubmit="saveExpense(event)">
                <div class="form-section">
                    <div class="form-section-title"><span>üí∏</span><span>Informaci√≥n del Gasto</span></div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Categor√≠a *</label>
                            <select id="exp-category" required style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Seleccionar...</option>
                                <option value="fuel">‚õΩ Combustible</option>
                                <option value="repair">üîß Reparaciones / Mantenimiento</option>
                                <option value="salary">üë§ Salarios de Choferes</option>
                                <option value="insurance">üõ°Ô∏è Seguros</option>
                                <option value="tolls">üõ£Ô∏è Peajes / Casetas</option>
                                <option value="permits">üìÑ Permisos y Licencias</option>
                                <option value="other">üì¶ Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="exp-date" required>
                        </div>
                        <div class="form-group">
                            <label>Monto (USD) *</label>
                            <input type="number" id="exp-amount" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Cami√≥n (Opcional)</label>
                            <select id="exp-truck" style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">General / No aplica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Chofer (Opcional)</label>
                            <select id="exp-driver" style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">General / No aplica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n *</label>
                            <textarea id="exp-description" placeholder="Descripci√≥n del gasto..." required></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeExpenseModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">üíæ Guardar Gasto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trip Modal -->
    <div id="trip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeTripModal()">‚Üê <span id="back-trip">Volver</span></button>
                <h2 id="modal-title-trip">üöö Nuevo Viaje</h2>
                <button class="close-btn" onclick="closeTripModal()">&times;</button>
            </div>

            <form id="trip-form" onsubmit="saveTrip(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üë§</span>
                        <span id="section-trip-driver">Asignaci√≥n de Chofer</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-trip-driver">Seleccionar Chofer *</label>
                            <select id="trip-driver" required>
                                <option value="">Seleccionar...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-trip-document">Documento / Carga a Recoger *</label>
                            <input type="text" id="trip-document" placeholder="Ej: BOL-12345, Pallets de electr√≥nicos" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìç</span>
                        <span id="section-trip-route">Ruta del Viaje</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-trip-pickup-address">Direcci√≥n de Recogida *</label>
                            <input type="text" id="trip-pickup-address" placeholder="Ej: 1234 Main St, Los Angeles, CA 90001" required>
                        </div>
                        <div class="form-group">
                            <label id="label-trip-destination-city">Ciudad de Destino *</label>
                            <select id="trip-destination" onchange="calculateTripDistance()" required style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Seleccionar ciudad...</option>
                                <option>Los Angeles, CA</option><option>Dallas, TX</option><option>Houston, TX</option>
                                <option>Chicago, IL</option><option>New York, NY</option><option>Miami, FL</option>
                                <option>Phoenix, AZ</option><option>Atlanta, GA</option><option>Las Vegas, NV</option>
                                <option>San Francisco, CA</option><option>Seattle, WA</option><option>Denver, CO</option>
                                <option>Boston, MA</option><option>Philadelphia, PA</option><option>San Diego, CA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-trip-pickup-city">Ciudad de Recogida *</label>
                            <select id="trip-pickup-city" onchange="calculateTripDistance()" required style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Seleccionar ciudad...</option>
                                <option>Los Angeles, CA</option><option>Dallas, TX</option><option>Houston, TX</option>
                                <option>Chicago, IL</option><option>New York, NY</option><option>Miami, FL</option>
                                <option>Phoenix, AZ</option><option>Atlanta, GA</option><option>Las Vegas, NV</option>
                                <option>San Francisco, CA</option><option>Seattle, WA</option><option>Denver, CO</option>
                                <option>Boston, MA</option><option>Philadelphia, PA</option><option>San Diego, CA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-trip-calculated-distance">üìè Distancia / Millas por Recorrer</label>
                            <div id="trip-distance-display" style="padding:20px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:8px;text-align:center;font-size:28px;font-weight:bold;color:#1e40af;">
                                -- mi
                            </div>
                            <!-- Progress Bar para c√°lculo -->
                            <div id="route-calc-progress" style="display:none;margin-top:10px;">
                                <div style="background:#e5e7eb;border-radius:8px;overflow:hidden;height:8px;">
                                    <div id="route-calc-bar" style="background:linear-gradient(90deg,#2563eb,#10b981);height:100%;width:0%;transition:width 0.3s;"></div>
                                </div>
                                <div id="route-calc-text" style="text-align:center;margin-top:5px;font-size:12px;color:#6b7280;">Calculando ruta...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìÑ</span>
                        <span id="section-trip-document">Documento del Viaje</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label id="label-trip-file">Subir Documento (Opcional)</label>
                            <input type="file" id="trip-file-upload" accept=".pdf,.jpg,.jpeg,.png" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;">
                            <small style="color:var(--text-light);font-size:12px;">El chofer podr√° ver este documento en su interfaz</small>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìÖ</span>
                        <span id="section-trip-dates">Fechas y Notas</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-trip-start-date">Fecha de Inicio *</label>
                            <input type="date" id="trip-start-date" required>
                        </div>
                        <div class="form-group">
                            <label id="label-trip-notes">Notas / Instrucciones</label>
                            <textarea id="trip-notes" rows="3" placeholder="Instrucciones especiales, horarios, etc."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeTripModal()" id="btn-trip-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-trip-save">üöö Crear Viaje</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeDocumentModal()">‚Üê <span id="back-document">Volver</span></button>
                <h2 id="modal-title-document">Subir Documento</h2>
                <button class="close-btn" onclick="closeDocumentModal()">&times;</button>
            </div>

            <form id="document-form" onsubmit="saveDocument(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label id="label-document-type">Tipo *</label>
                        <select id="document-type" required>
                            <option value="">Seleccionar...</option>
                            <option value="driver">Chofer</option>
                            <option value="truck">Cami√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-document-entity">Relacionado con *</label>
                        <select id="document-entity" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-document-category">Categor√≠a *</label>
                        <select id="document-category" required>
                            <option value="">Seleccionar...</option>
                            <option value="license">Licencia</option>
                            <option value="medical">Certificado M√©dico</option>
                            <option value="insurance">Seguro</option>
                            <option value="inspection">Inspecci√≥n</option>
                            <option value="certification">Certificaci√≥n</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-document-name">Nombre del Documento *</label>
                        <input type="text" id="document-name" required>
                    </div>
                    <div class="form-group">
                        <label id="label-document-expiry">Fecha de Vencimiento</label>
                        <input type="date" id="document-expiry">
                    </div>
                    <div class="form-group full-width">
                        <label id="label-document-file">Archivo</label>
                        <div class="upload-area" id="upload-area">
                            <p>üìÅ Arrastra el archivo aqu√≠ o haz clic para seleccionar</p>
                            <input type="file" id="document-file" style="display: none;" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        </div>
                        <div id="file-name" style="margin-top: 10px; font-weight: 500;"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeDocumentModal()" id="btn-document-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-document-save">üíæ Subir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Driver Details Modal -->
    <div id="driver-details-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <button class="back-btn" onclick="closeDriverDetailsModal()">‚Üê <span id="back-details">Volver</span></button>
                <h2 id="driver-details-name"></h2>
                <button class="close-btn" onclick="closeDriverDetailsModal()">&times;</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchDetailsTab('info')" id="details-tab-info">Informaci√≥n</button>
                <button class="tab" onclick="switchDetailsTab('assignments')" id="details-tab-assignments">Asignaciones</button>
                <button class="tab" onclick="switchDetailsTab('documents')" id="details-tab-documents">Documentos</button>
            </div>

            <div id="details-tab-info-content" class="tab-content active">
                <div id="driver-details-info"></div>
            </div>

            <div id="details-tab-assignments-content" class="tab-content">
                <div id="driver-details-assignments"></div>
            </div>

            <div id="details-tab-documents-content" class="tab-content">
                <div id="driver-details-documents"></div>
            </div>
        </div>
    </div>

    <!-- Broker Modal -->
    <div id="broker-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeBrokerModal()">‚Üê <span id="back-broker">Volver</span></button>
                <h2 id="modal-title-broker">Agregar Broker/Dispatch</h2>
                <button class="close-btn" onclick="closeBrokerModal()">&times;</button>
            </div>

            <form id="broker-form" onsubmit="saveBroker(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>ü§ù</span>
                        <span id="section-broker-info">Informaci√≥n de Broker/Dispatch</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-broker-type">Tipo *</label>
                            <select id="broker-type" required>
                                <option value="">Seleccionar...</option>
                                <option value="broker">Broker</option>
                                <option value="dispatch">Dispatch</option>
                                <option value="both">Ambos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-broker-company">Compa√±√≠a *</label>
                            <input type="text" id="broker-company" required>
                        </div>
                        <div class="form-group">
                            <label id="label-broker-contact">Nombre de Contacto *</label>
                            <input type="text" id="broker-contact-name" required>
                        </div>
                        <div class="form-group">
                            <label id="label-broker-position">Posici√≥n/Cargo</label>
                            <input type="text" id="broker-position">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìû</span>
                        <span id="section-broker-contact">Informaci√≥n de Contacto</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-broker-email-input">Email *</label>
                            <input type="email" id="broker-email" required>
                        </div>
                        <div class="form-group">
                            <label id="label-broker-phone-input">Tel√©fono Principal *</label>
                            <input type="tel" id="broker-phone" required>
                        </div>
                        <div class="form-group">
                            <label id="label-broker-phone2">Tel√©fono Secundario</label>
                            <input type="tel" id="broker-phone2">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-fax">Fax</label>
                            <input type="tel" id="broker-fax">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìç</span>
                        <span id="section-broker-address">Direcci√≥n</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label id="label-broker-address">Direcci√≥n</label>
                            <input type="text" id="broker-address">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-city">Ciudad</label>
                            <input type="text" id="broker-city">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-state">Estado/Provincia</label>
                            <input type="text" id="broker-state">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-zip">C√≥digo Postal</label>
                            <input type="text" id="broker-zip">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-country">Pa√≠s</label>
                            <input type="text" id="broker-country" value="USA">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìã</span>
                        <span id="section-broker-additional">Informaci√≥n Adicional</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-broker-mc">MC Number</label>
                            <input type="text" id="broker-mc">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-dot">DOT Number</label>
                            <input type="text" id="broker-dot">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-ein">EIN/Tax ID</label>
                            <input type="text" id="broker-ein">
                        </div>
                        <div class="form-group">
                            <label id="label-broker-payment-terms">T√©rminos de Pago</label>
                            <select id="broker-payment-terms">
                                <option value="">Seleccionar...</option>
                                <option value="Quick Pay">Quick Pay</option>
                                <option value="15 Days">15 D√≠as</option>
                                <option value="30 Days">30 D√≠as</option>
                                <option value="45 Days">45 D√≠as</option>
                                <option value="60 Days">60 D√≠as</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label id="label-broker-status-input">Estado *</label>
                        <select id="broker-status" required>
                            <option value="active" id="broker-status-active">Activo</option>
                            <option value="inactive" id="broker-status-inactive">Inactivo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="label-broker-notes">Notas</label>
                        <textarea id="broker-notes"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeBrokerModal()" id="btn-broker-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-broker-save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Documents Modal -->
    <div id="send-documents-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeSendDocumentsModal()">‚Üê <span id="back-send-docs">Volver</span></button>
                <h2 id="modal-title-send-docs">üì§ Enviar Documentos</h2>
                <button class="close-btn" onclick="closeSendDocumentsModal()">&times;</button>
            </div>

            <form id="send-documents-form" onsubmit="sendDocumentsToBroker(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>ü§ù</span>
                        <span id="section-select-broker">Seleccionar Destinatario</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label id="label-send-to-broker">Enviar a *</label>
                            <select id="send-to-broker" required onchange="updateBrokerInfo()">
                                <option value="">Seleccionar Broker/Dispatch...</option>
                            </select>
                        </div>
                        <div id="broker-info-display" class="form-group full-width" style="display: none;">
                            <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div>
                                        <strong>Email:</strong> <span id="broker-info-email"></span>
                                    </div>
                                    <div>
                                        <strong>Tel√©fono:</strong> <span id="broker-info-phone"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üìÑ</span>
                        <span id="section-select-documents">Seleccionar Documentos</span>
                    </div>
                    <div id="documents-checklist">
                        <!-- Documents checklist will be loaded here -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label id="label-send-message">Mensaje (opcional)</label>
                        <textarea id="send-message" rows="4" placeholder="Agregar un mensaje personalizado..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeSendDocumentsModal()" id="btn-send-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-send-submit">üì§ Enviar Documentos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeUserModal()">‚Üê <span id="back-user">Volver</span></button>
                <h2 id="modal-title-user">Agregar Usuario</h2>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>

            <form id="user-form" onsubmit="saveUser(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üë§</span>
                        <span id="section-user-info">Informaci√≥n del Usuario</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-user-select-driver">Seleccionar Chofer *</label>
                            <select id="user-driver-select" onchange="fillUserDataFromDriver()" required style="padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
                                <option value="">Seleccionar chofer del sistema...</option>
                            </select>
                            <small style="color:var(--text-light);font-size:12px;">Los datos se llenar√°n autom√°ticamente</small>
                        </div>
                        <div class="form-group">
                            <label id="label-user-name">Nombre Completo *</label>
                            <input type="text" id="user-name-input" readonly style="background:#f3f4f6;" required>
                        </div>
                        <div class="form-group">
                            <label id="label-user-username">Usuario *</label>
                            <input type="text" id="user-username" required placeholder="Crear nombre de usuario">
                        </div>
                        <div class="form-group">
                            <label id="label-user-email">Email *</label>
                            <input type="email" id="user-email" readonly style="background:#f3f4f6;" required>
                        </div>
                        <div class="form-group">
                            <label id="label-user-phone">Tel√©fono</label>
                            <input type="tel" id="user-phone" readonly style="background:#f3f4f6;">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üîê</span>
                        <span id="section-user-security">Seguridad</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-user-password">Contrase√±a *</label>
                            <input type="password" id="user-password" required>
                        </div>
                        <div class="form-group">
                            <label id="label-user-password2">Confirmar Contrase√±a *</label>
                            <input type="password" id="user-password2" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-user-role-select">Rol *</label>
                            <select id="user-role-select" required>
                                <option value="">Seleccionar...</option>
                                <option value="admin">Administrador</option>
                                <option value="user">Usuario</option>
                                <option value="driver">Chofer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-user-status-input">Estado *</label>
                            <select id="user-status" required>
                                <option value="active">Activo</option>
                                <option value="inactive">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeUserModal()" id="btn-user-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-user-save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal (Edit Own Profile) -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" onclick="closeProfileModal()">‚Üê <span id="back-profile">Volver</span></button>
                <h2 id="modal-title-profile">Mi Perfil</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>

            <form id="profile-form" onsubmit="saveProfile(event)">
                <div class="form-section">
                    <div class="form-section-title">
                        <span>üë§</span>
                        <span id="section-profile-info">Informaci√≥n Personal</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-profile-name">Nombre Completo *</label>
                            <input type="text" id="profile-name" required>
                        </div>
                        <div class="form-group">
                            <label id="label-profile-username">Usuario *</label>
                            <input type="text" id="profile-username" required>
                            <small style="color: var(--text-light); font-size: 12px;" id="profile-username-hint">
                                Puedes cambiar tu nombre de usuario
                            </small>
                        </div>
                        <div class="form-group">
                            <label id="label-profile-email">Email</label>
                            <input type="email" id="profile-email">
                        </div>
                        <div class="form-group">
                            <label id="label-profile-phone">Tel√©fono</label>
                            <input type="tel" id="profile-phone">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <span>üîê</span>
                        <span id="section-profile-password">Cambiar Contrase√±a</span>
                    </div>
                    <div style="padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; margin-bottom: 15px;">
                        <small style="color: #92400e;" id="profile-password-info">
                            ‚ÑπÔ∏è Deja los campos vac√≠os si no quieres cambiar la contrase√±a
                        </small>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label id="label-profile-current-password">Contrase√±a Actual</label>
                            <input type="password" id="profile-current-password" placeholder="Requerida para cambiar contrase√±a">
                        </div>
                        <div class="form-group">
                            <label id="label-profile-new-password">Nueva Contrase√±a</label>
                            <input type="password" id="profile-new-password" placeholder="Dejar vac√≠o para mantener">
                        </div>
                        <div class="form-group">
                            <label id="label-profile-confirm-password">Confirmar Nueva Contrase√±a</label>
                            <input type="password" id="profile-confirm-password" placeholder="Confirmar nueva contrase√±a">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div style="padding: 15px; background: var(--light-bg); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px;">
                            <strong id="profile-role-label">Rol:</strong>
                            <span id="profile-role-value"></span>
                            
                            <strong id="profile-status-label">Estado:</strong>
                            <span id="profile-status-value"></span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeProfileModal()" id="btn-profile-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btn-profile-save">üíæ Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database simulation using localStorage
        class Database {
            constructor() {
                this.initDB();
            }

            initDB() {
                if (!localStorage.getItem('drivers')) {
                    localStorage.setItem('drivers', JSON.stringify([]));
                }
                if (!localStorage.getItem('trucks')) {
                    localStorage.setItem('trucks', JSON.stringify([]));
                }
                if (!localStorage.getItem('assignments')) {
                    localStorage.setItem('assignments', JSON.stringify([]));
                }
                if (!localStorage.getItem('documents')) {
                    localStorage.setItem('documents', JSON.stringify([]));
                }
                if (!localStorage.getItem('brokers')) {
                    localStorage.setItem('brokers', JSON.stringify([]));
                }
                if (!localStorage.getItem('sentDocuments')) {
                    localStorage.setItem('sentDocuments', JSON.stringify([]));
                }
                if (!localStorage.getItem('users')) {
                    // Create default admin user
                    const defaultAdmin = {
                        id: 1,
                        name: 'Administrador',
                        username: 'admin',
                        email: 'admin@fleetmanager.com',
                        password: 'admin123',
                        role: 'admin',
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    localStorage.setItem('users', JSON.stringify([defaultAdmin]));
                }
                if (!localStorage.getItem('company')) {
                    // Create default company info
                    const defaultCompany = {
                        name: 'Fleet Manager',
                        legalName: '',
                        taxId: '',
                        mcNumber: '',
                        dotNumber: '',
                        usdot: '',
                        phone: '',
                        phone2: '',
                        email: '',
                        website: '',
                        fax: '',
                        address: '',
                        city: '',
                        state: '',
                        zip: '',
                        country: 'USA',
                        logo: '',
                        founded: '',
                        employees: '',
                        fleetSize: '',
                        currency: 'USD',
                        description: ''
                    };
                    localStorage.setItem('company', JSON.stringify(defaultCompany));
                }
            }

            getDrivers() {
                return JSON.parse(localStorage.getItem('drivers')) || [];
            }

            saveDriver(driver) {
                const drivers = this.getDrivers();
                driver.id = drivers.length > 0 ? Math.max(...drivers.map(d => d.id)) + 1 : 1;
                driver.createdAt = new Date().toISOString();
                drivers.push(driver);
                localStorage.setItem('drivers', JSON.stringify(drivers));
                return driver;
            }

            updateDriver(id, data) {
                const drivers = this.getDrivers();
                const index = drivers.findIndex(d => d.id === id);
                if (index !== -1) {
                    drivers[index] = { ...drivers[index], ...data, updatedAt: new Date().toISOString() };
                    localStorage.setItem('drivers', JSON.stringify(drivers));
                    return drivers[index];
                }
                return null;
            }

            deleteDriver(id) {
                let drivers = this.getDrivers();
                drivers = drivers.filter(d => d.id !== id);
                localStorage.setItem('drivers', JSON.stringify(drivers));
            }

            getTrucks() {
                return JSON.parse(localStorage.getItem('trucks')) || [];
            }

            saveTruck(truck) {
                const trucks = this.getTrucks();
                truck.id = trucks.length > 0 ? Math.max(...trucks.map(t => t.id)) + 1 : 1;
                truck.createdAt = new Date().toISOString();
                trucks.push(truck);
                localStorage.setItem('trucks', JSON.stringify(trucks));
                return truck;
            }

            updateTruck(id, data) {
                const trucks = this.getTrucks();
                const index = trucks.findIndex(t => t.id === id);
                if (index !== -1) {
                    trucks[index] = { ...trucks[index], ...data, updatedAt: new Date().toISOString() };
                    localStorage.setItem('trucks', JSON.stringify(trucks));
                    return trucks[index];
                }
                return null;
            }

            deleteTruck(id) {
                let trucks = this.getTrucks();
                trucks = trucks.filter(t => t.id !== id);
                localStorage.setItem('trucks', JSON.stringify(trucks));
            }

            getAssignments() {
                return JSON.parse(localStorage.getItem('assignments')) || [];
            }

            saveAssignment(assignment) {
                const assignments = this.getAssignments();
                assignment.id = assignments.length > 0 ? Math.max(...assignments.map(a => a.id)) + 1 : 1;
                assignment.createdAt = new Date().toISOString();
                assignment.status = 'active';
                assignments.push(assignment);
                localStorage.setItem('assignments', JSON.stringify(assignments));
                return assignment;
            }

            endAssignment(id) {
                const assignments = this.getAssignments();
                const index = assignments.findIndex(a => a.id === id);
                if (index !== -1) {
                    assignments[index].status = 'inactive';
                    assignments[index].endDate = new Date().toISOString().split('T')[0];
                    localStorage.setItem('assignments', JSON.stringify(assignments));
                    return assignments[index];
                }
                return null;
            }

            getDocuments() {
                return JSON.parse(localStorage.getItem('documents')) || [];
            }

            saveDocument(document) {
                const documents = this.getDocuments();
                document.id = documents.length > 0 ? Math.max(...documents.map(d => d.id)) + 1 : 1;
                document.createdAt = new Date().toISOString();
                document.uploadDate = new Date().toISOString().split('T')[0];
                document.status = 'pending';
                documents.push(document);
                localStorage.setItem('documents', JSON.stringify(documents));
                return document;
            }

            updateDocumentStatus(id, status, comments = '') {
                const documents = this.getDocuments();
                const index = documents.findIndex(d => d.id === id);
                if (index !== -1) {
                    documents[index].status = status;
                    documents[index].comments = comments;
                    documents[index].reviewedDate = new Date().toISOString().split('T')[0];
                    localStorage.setItem('documents', JSON.stringify(documents));
                    return documents[index];
                }
                return null;
            }

            getBrokers() {
                return JSON.parse(localStorage.getItem('brokers')) || [];
            }

            saveBroker(broker) {
                const brokers = this.getBrokers();
                broker.id = brokers.length > 0 ? Math.max(...brokers.map(b => b.id)) + 1 : 1;
                broker.createdAt = new Date().toISOString();
                brokers.push(broker);
                localStorage.setItem('brokers', JSON.stringify(brokers));
                return broker;
            }

            updateBroker(id, data) {
                const brokers = this.getBrokers();
                const index = brokers.findIndex(b => b.id === id);
                if (index !== -1) {
                    brokers[index] = { ...brokers[index], ...data, updatedAt: new Date().toISOString() };
                    localStorage.setItem('brokers', JSON.stringify(brokers));
                    return brokers[index];
                }
                return null;
            }

            deleteBroker(id) {
                let brokers = this.getBrokers();
                brokers = brokers.filter(b => b.id !== id);
                localStorage.setItem('brokers', JSON.stringify(brokers));
            }

            getSentDocuments() {
                return JSON.parse(localStorage.getItem('sentDocuments')) || [];
            }

            saveSentDocument(sentDoc) {
                const sentDocs = this.getSentDocuments();
                sentDoc.id = sentDocs.length > 0 ? Math.max(...sentDocs.map(s => s.id)) + 1 : 1;
                sentDoc.sentAt = new Date().toISOString();
                sentDocs.push(sentDoc);
                localStorage.setItem('sentDocuments', JSON.stringify(sentDocs));
                return sentDoc;
            }

            getUsers() {
                return JSON.parse(localStorage.getItem('users')) || [];
            }

            saveUser(user) {
                const users = this.getUsers();
                user.id = users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1;
                user.createdAt = new Date().toISOString();
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                return user;
            }

            updateUser(id, data) {
                const users = this.getUsers();
                const index = users.findIndex(u => u.id === id);
                if (index !== -1) {
                    users[index] = { ...users[index], ...data, updatedAt: new Date().toISOString() };
                    localStorage.setItem('users', JSON.stringify(users));
                    return users[index];
                }
                return null;
            }

            deleteUser(id) {
                let users = this.getUsers();
                users = users.filter(u => u.id !== id);
                localStorage.setItem('users', JSON.stringify(users));
            }

            getUserByUsername(username) {
                const users = this.getUsers();
                return users.find(u => u.username === username);
            }

            validateLogin(username, password) {
                const user = this.getUserByUsername(username);
                if (user && user.password === password && user.status === 'active') {
                    return user;
                }
                return null;
            }

            getCompany() {
                return JSON.parse(localStorage.getItem('company')) || {};
            }

            saveCompany(company) {
                localStorage.setItem('company', JSON.stringify(company));
                return company;
            }
        }

        const db = new Database();
        let currentUser = null;

        // Translations
        const translations = {
            es: {
                'menu-dashboard': 'Dashboard',
                'menu-drivers': 'Choferes',
                'menu-trucks': 'Camiones',
                'menu-assignments': 'Asignaciones',
                'menu-trips': 'Viajes',
                'title-trips': 'üöö Viajes',
                'btn-new-trip': 'Nuevo Viaje',
                'menu-documents': 'Documentos',
                'menu-reports': 'Reportes',
                'title-dashboard': 'Dashboard',
                'title-drivers': 'üë§ Choferes',
                'title-trucks': 'üöõ Camiones',
                'title-assignments': 'üîó Asignaciones',
                'title-documents': 'üìÅ Documentos',
                'title-reports': 'üìà Reportes',
                'btn-add-driver': 'Agregar Chofer',
                'btn-add-truck': 'Agregar Cami√≥n',
                'btn-new-assignment': 'Nueva Asignaci√≥n',
                'btn-upload-doc': 'Subir Documento',
                'btn-send-docs': 'Enviar a Broker',
                'btn-search': 'Buscar',
                'label-total-drivers': 'Total de Choferes',
                'label-total-trucks': 'Total de Camiones',
                'label-available-trucks': 'Camiones Disponibles',
                'label-pending-docs': 'Documentos Pendientes',
                'label-expiring-soon': '‚ö†Ô∏è Vencimientos Pr√≥ximos',
                'no-alerts': '‚úÖ No hay documentos pr√≥ximos a vencer',
                'th-name': 'Nombre',
                'th-license': 'Licencia',
                'th-phone': 'Tel√©fono',
                'th-email': 'Email',
                'th-status': 'Estado',
                'th-actions': 'Acciones',
                'modal-title-driver': 'Agregar Chofer',
                'btn-cancel': 'Cancelar',
                'btn-save': 'üíæ Guardar',
                'section-personal-info': 'Informaci√≥n Personal',
                'section-address': 'Direcci√≥n',
                'section-license': 'Licencia',
                'section-emergency': 'Contacto de Emergencia',
                'label-first-name': 'Nombre *',
                'label-last-name': 'Apellido *',
                'label-phone': 'Tel√©fono *',
                'label-email': 'Email',
                'label-dob': 'Fecha de Nacimiento',
                'label-hire-date': 'Fecha de Contrataci√≥n',
                'label-address': 'Direcci√≥n',
                'label-city': 'Ciudad',
                'label-state': 'Estado/Provincia',
                'label-license-number': 'N√∫mero de Licencia *',
                'label-license-type': 'Tipo de Licencia',
                'label-license-expiry': 'Vencimiento de Licencia',
                'label-medical-cert': 'Venc. Certificado M√©dico',
                'label-emergency-name': 'Nombre',
                'label-emergency-phone': 'Tel√©fono',
                'label-driver-status': 'Estado *',
                'label-notes': 'Notas',
                'status-active': 'Activo',
                'status-inactive': 'Inactivo',
                'status-suspended': 'Suspendido',
                'menu-brokers': 'Brokers & Dispatch',
                'title-brokers': 'ü§ù Brokers & Dispatch',
                'btn-add-broker': 'Agregar Broker/Dispatch',
                'btn-search-broker': 'Buscar',
                'th-broker-type': 'Tipo',
                'th-broker-company': 'Compa√±√≠a',
                'th-broker-contact': 'Contacto',
                'th-broker-email': 'Email',
                'th-broker-phone': 'Tel√©fono',
                'th-broker-status': 'Estado',
                'th-broker-actions': 'Acciones',
                'modal-title-broker': 'Agregar Broker/Dispatch',
                'section-broker-info': 'Informaci√≥n de Broker/Dispatch',
                'label-broker-type': 'Tipo *',
                'label-broker-company': 'Compa√±√≠a *',
                'label-broker-contact': 'Nombre de Contacto *',
                'label-broker-position': 'Posici√≥n/Cargo',
                'section-broker-contact': 'Informaci√≥n de Contacto',
                'label-broker-email-input': 'Email *',
                'label-broker-phone-input': 'Tel√©fono Principal *',
                'label-broker-phone2': 'Tel√©fono Secundario',
                'label-broker-fax': 'Fax',
                'section-broker-address': 'Direcci√≥n',
                'label-broker-address': 'Direcci√≥n',
                'label-broker-city': 'Ciudad',
                'label-broker-state': 'Estado/Provincia',
                'label-broker-zip': 'C√≥digo Postal',
                'label-broker-country': 'Pa√≠s',
                'section-broker-additional': 'Informaci√≥n Adicional',
                'label-broker-mc': 'MC Number',
                'label-broker-dot': 'DOT Number',
                'label-broker-ein': 'EIN/Tax ID',
                'label-broker-payment-terms': 'T√©rminos de Pago',
                'label-broker-status-input': 'Estado *',
                'label-broker-notes': 'Notas',
                'btn-broker-cancel': 'Cancelar',
                'btn-broker-save': 'üíæ Guardar',
                'broker-status-active': 'Activo',
                'broker-status-inactive': 'Inactivo',
                'modal-title-send-docs': 'üì§ Enviar Documentos',
                'section-select-broker': 'Seleccionar Destinatario',
                'label-send-to-broker': 'Enviar a *',
                'section-select-documents': 'Seleccionar Documentos',
                'label-send-message': 'Mensaje (opcional)',
                'btn-send-cancel': 'Cancelar',
                'btn-send-submit': 'üì§ Enviar Documentos',
                'menu-users': 'Usuarios',
                'menu-settings': 'Configuraci√≥n',
                'menu-profile': 'Mi Perfil',
                'menu-logout': 'Cerrar Sesi√≥n',
                'menu-company': 'Empresa',
                'title-company': 'üè¢ Informaci√≥n de la Empresa',
                'btn-save-company': 'Guardar Cambios',
                'section-company-basic': 'Informaci√≥n B√°sica',
                'label-company-name': 'Nombre de la Empresa *',
                'label-company-legal-name': 'Nombre Legal',
                'label-company-tax-id': 'Tax ID / EIN *',
                'label-company-mc': 'MC Number',
                'label-company-dot': 'DOT Number',
                'label-company-usdot': 'USDOT Number',
                'section-company-contact': 'Informaci√≥n de Contacto',
                'label-company-phone': 'Tel√©fono Principal *',
                'label-company-phone2': 'Tel√©fono Secundario',
                'label-company-email': 'Email *',
                'label-company-website': 'Sitio Web',
                'label-company-fax': 'Fax',
                'section-company-address': 'Direcci√≥n',
                'label-company-address': 'Direcci√≥n *',
                'label-company-city': 'Ciudad *',
                'label-company-state': 'Estado/Provincia *',
                'label-company-zip': 'C√≥digo Postal *',
                'label-company-country': 'Pa√≠s *',
                'section-company-logo': 'Logo de la Empresa',
                'label-company-logo': 'Logo (Imagen)',
                'btn-upload-logo': 'Subir Logo',
                'logo-help': 'Formatos: JPG, PNG, GIF. Tama√±o recomendado: 300x300px',
                'btn-remove-logo': 'Eliminar Logo',
                'section-company-additional': 'Informaci√≥n Adicional',
                'label-company-founded': 'A√±o de Fundaci√≥n',
                'label-company-employees': 'N√∫mero de Empleados',
                'label-company-fleet-size': 'Tama√±o de Flota',
                'label-company-currency': 'Moneda',
                'label-company-description': 'Descripci√≥n',
                'title-users': 'üë• Usuarios',
                'btn-add-user': 'Agregar Usuario',
                'btn-search-user': 'Buscar',
                'th-user-name': 'Nombre',
                'th-user-username': 'Usuario',
                'th-user-email': 'Email',
                'th-user-role': 'Rol',
                'th-user-status': 'Estado',
                'th-user-actions': 'Acciones',
                'back-driver': 'Volver',
                'back-truck': 'Volver',
                'back-assignment': 'Volver',
                'back-document': 'Volver',
                'back-details': 'Volver',
                'back-broker': 'Volver',
                'back-send-docs': 'Volver',
                'back-user': 'Volver',
                'back-to-login': 'Volver',
                'modal-title-user': 'Agregar Usuario',
                'section-user-info': 'Informaci√≥n del Usuario',
                'label-user-name': 'Nombre Completo *',
                'label-user-username': 'Usuario *',
                'label-user-email': 'Email *',
                'label-user-phone': 'Tel√©fono',
                'section-user-security': 'Seguridad',
                'label-user-password': 'Contrase√±a *',
                'label-user-password2': 'Confirmar Contrase√±a *',
                'label-user-role-select': 'Rol *',
                'label-user-status-input': 'Estado *',
                'btn-user-cancel': 'Cancelar',
                'btn-user-save': 'üíæ Guardar',
                'back-profile': 'Volver',
                'modal-title-profile': 'Mi Perfil',
                'section-profile-info': 'Informaci√≥n Personal',
                'label-profile-name': 'Nombre Completo *',
                'label-profile-username': 'Usuario *',
                'profile-username-hint': 'Puedes cambiar tu nombre de usuario',
                'label-profile-email': 'Email',
                'label-profile-phone': 'Tel√©fono',
                'section-profile-password': 'Cambiar Contrase√±a',
                'profile-password-info': '‚ÑπÔ∏è Deja los campos vac√≠os si no quieres cambiar la contrase√±a',
                'label-profile-current-password': 'Contrase√±a Actual',
                'label-profile-new-password': 'Nueva Contrase√±a',
                'label-profile-confirm-password': 'Confirmar Nueva Contrase√±a',
                'profile-role-label': 'Rol:',
                'profile-status-label': 'Estado:',
                'btn-profile-cancel': 'Cancelar',
                'btn-profile-save': 'üíæ Guardar Cambios',
            },
            en: {
                'menu-dashboard': 'Dashboard',
                'menu-drivers': 'Drivers',
                'menu-trucks': 'Trucks',
                'menu-assignments': 'Assignments',
                'menu-trips': 'Trips',
                'title-trips': 'üöö Trips',
                'btn-new-trip': 'New Trip',
                'menu-documents': 'Documents',
                'menu-reports': 'Reports',
                'title-dashboard': 'Dashboard',
                'title-drivers': 'üë§ Drivers',
                'title-trucks': 'üöõ Trucks',
                'title-assignments': 'üîó Assignments',
                'title-documents': 'üìÅ Documents',
                'title-reports': 'üìà Reports',
                'btn-add-driver': 'Add Driver',
                'btn-add-truck': 'Add Truck',
                'btn-new-assignment': 'New Assignment',
                'btn-upload-doc': 'Upload Document',
                'btn-send-docs': 'Send to Broker',
                'btn-search': 'Search',
                'label-total-drivers': 'Total Drivers',
                'label-total-trucks': 'Total Trucks',
                'label-available-trucks': 'Available Trucks',
                'label-pending-docs': 'Pending Documents',
                'label-expiring-soon': '‚ö†Ô∏è Expiring Soon',
                'no-alerts': '‚úÖ No documents expiring soon',
                'th-name': 'Name',
                'th-license': 'License',
                'th-phone': 'Phone',
                'th-email': 'Email',
                'th-status': 'Status',
                'th-actions': 'Actions',
                'modal-title-driver': 'Add Driver',
                'btn-cancel': 'Cancel',
                'btn-save': 'üíæ Save',
                'section-personal-info': 'Personal Information',
                'section-address': 'Address',
                'section-license': 'License',
                'section-emergency': 'Emergency Contact',
                'label-first-name': 'First Name *',
                'label-last-name': 'Last Name *',
                'label-phone': 'Phone *',
                'label-email': 'Email',
                'label-dob': 'Date of Birth',
                'label-hire-date': 'Hire Date',
                'label-address': 'Address',
                'label-city': 'City',
                'label-state': 'State/Province',
                'label-license-number': 'License Number *',
                'label-license-type': 'License Type',
                'label-license-expiry': 'License Expiry',
                'label-medical-cert': 'Medical Cert. Expiry',
                'label-emergency-name': 'Name',
                'label-emergency-phone': 'Phone',
                'label-driver-status': 'Status *',
                'label-notes': 'Notes',
                'status-active': 'Active',
                'status-inactive': 'Inactive',
                'status-suspended': 'Suspended',
                'menu-brokers': 'Brokers & Dispatch',
                'title-brokers': 'ü§ù Brokers & Dispatch',
                'btn-add-broker': 'Add Broker/Dispatch',
                'btn-search-broker': 'Search',
                'th-broker-type': 'Type',
                'th-broker-company': 'Company',
                'th-broker-contact': 'Contact',
                'th-broker-email': 'Email',
                'th-broker-phone': 'Phone',
                'th-broker-status': 'Status',
                'th-broker-actions': 'Actions',
                'modal-title-broker': 'Add Broker/Dispatch',
                'section-broker-info': 'Broker/Dispatch Information',
                'label-broker-type': 'Type *',
                'label-broker-company': 'Company *',
                'label-broker-contact': 'Contact Name *',
                'label-broker-position': 'Position/Title',
                'section-broker-contact': 'Contact Information',
                'label-broker-email-input': 'Email *',
                'label-broker-phone-input': 'Main Phone *',
                'label-broker-phone2': 'Secondary Phone',
                'label-broker-fax': 'Fax',
                'section-broker-address': 'Address',
                'label-broker-address': 'Address',
                'label-broker-city': 'City',
                'label-broker-state': 'State/Province',
                'label-broker-zip': 'Zip Code',
                'label-broker-country': 'Country',
                'section-broker-additional': 'Additional Information',
                'label-broker-mc': 'MC Number',
                'label-broker-dot': 'DOT Number',
                'label-broker-ein': 'EIN/Tax ID',
                'label-broker-payment-terms': 'Payment Terms',
                'label-broker-status-input': 'Status *',
                'label-broker-notes': 'Notes',
                'btn-broker-cancel': 'Cancel',
                'btn-broker-save': 'üíæ Save',
                'broker-status-active': 'Active',
                'broker-status-inactive': 'Inactive',
                'modal-title-send-docs': 'üì§ Send Documents',
                'section-select-broker': 'Select Recipient',
                'label-send-to-broker': 'Send to *',
                'section-select-documents': 'Select Documents',
                'label-send-message': 'Message (optional)',
                'btn-send-cancel': 'Cancel',
                'btn-send-submit': 'üì§ Send Documents',
                'menu-users': 'Users',
                'menu-settings': 'Settings',
                'menu-profile': 'My Profile',
                'menu-logout': 'Logout',
                'menu-company': 'Company',
                'title-company': 'üè¢ Company Information',
                'btn-save-company': 'Save Changes',
                'section-company-basic': 'Basic Information',
                'label-company-name': 'Company Name *',
                'label-company-legal-name': 'Legal Name',
                'label-company-tax-id': 'Tax ID / EIN *',
                'label-company-mc': 'MC Number',
                'label-company-dot': 'DOT Number',
                'label-company-usdot': 'USDOT Number',
                'section-company-contact': 'Contact Information',
                'label-company-phone': 'Main Phone *',
                'label-company-phone2': 'Secondary Phone',
                'label-company-email': 'Email *',
                'label-company-website': 'Website',
                'label-company-fax': 'Fax',
                'section-company-address': 'Address',
                'label-company-address': 'Address *',
                'label-company-city': 'City *',
                'label-company-state': 'State/Province *',
                'label-company-zip': 'Zip Code *',
                'label-company-country': 'Country *',
                'section-company-logo': 'Company Logo',
                'label-company-logo': 'Logo (Image)',
                'btn-upload-logo': 'Upload Logo',
                'logo-help': 'Formats: JPG, PNG, GIF. Recommended size: 300x300px',
                'btn-remove-logo': 'Remove Logo',
                'section-company-additional': 'Additional Information',
                'label-company-founded': 'Year Founded',
                'label-company-employees': 'Number of Employees',
                'label-company-fleet-size': 'Fleet Size',
                'label-company-currency': 'Currency',
                'label-company-description': 'Description',
                'title-users': 'üë• Users',
                'btn-add-user': 'Add User',
                'btn-search-user': 'Search',
                'th-user-name': 'Name',
                'th-user-username': 'Username',
                'th-user-email': 'Email',
                'th-user-role': 'Role',
                'th-user-status': 'Status',
                'th-user-actions': 'Actions',
                'back-driver': 'Back',
                'back-truck': 'Back',
                'back-assignment': 'Back',
                'back-document': 'Back',
                'back-details': 'Back',
                'back-broker': 'Back',
                'back-send-docs': 'Back',
                'back-user': 'Back',
                'back-to-login': 'Back',
                'modal-title-user': 'Add User',
                'section-user-info': 'User Information',
                'label-user-name': 'Full Name *',
                'label-user-username': 'Username *',
                'label-user-email': 'Email *',
                'label-user-phone': 'Phone',
                'section-user-security': 'Security',
                'label-user-password': 'Password *',
                'label-user-password2': 'Confirm Password *',
                'label-user-role-select': 'Role *',
                'label-user-status-input': 'Status *',
                'btn-user-cancel': 'Cancel',
                'btn-user-save': 'üíæ Save',
                'back-profile': 'Back',
                'modal-title-profile': 'My Profile',
                'section-profile-info': 'Personal Information',
                'label-profile-name': 'Full Name *',
                'label-profile-username': 'Username *',
                'profile-username-hint': 'You can change your username',
                'label-profile-email': 'Email',
                'label-profile-phone': 'Phone',
                'section-profile-password': 'Change Password',
                'profile-password-info': '‚ÑπÔ∏è Leave fields empty if you don\'t want to change password',
                'label-profile-current-password': 'Current Password',
                'label-profile-new-password': 'New Password',
                'label-profile-confirm-password': 'Confirm New Password',
                'profile-role-label': 'Role:',
                'profile-status-label': 'Status:',
                'btn-profile-cancel': 'Cancel',
                'btn-profile-save': 'üíæ Save Changes',
            }
        };

        let currentLanguage = 'es';

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelector').value;
            updateTexts();
        }

        function updateTexts() {
            const lang = translations[currentLanguage];
            Object.keys(lang).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = lang[key];
                    } else {
                        element.textContent = lang[key];
                    }
                }
            });
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').classList.remove('hidden');

            // Add active class to clicked menu item
            event.currentTarget.classList.add('active');

            // Load data for the section
            if (sectionName === 'dashboard') {
                loadDashboard();
            } else if (sectionName === 'drivers') {
                loadDrivers();
            } else if (sectionName === 'trucks') {
                loadTrucks();
            } else if (sectionName === 'assignments') {
                loadAssignments();
            } else if (sectionName === 'trips') {
                loadTrips();
            } else if (sectionName === 'documents') {
                loadDocuments();
            } else if (sectionName === 'brokers') {
                loadBrokers();
            } else if (sectionName === 'invoices') {
                loadInvoices();
            } else if (sectionName === 'expenses') {
                loadExpenses();
            } else if (sectionName === 'accounting') {
                loadAccounting();
            } else if (sectionName === 'company') {
                loadCompanyInfo();
            } else if (sectionName === 'users') {
                loadUsers();
            }
        }

        // Dashboard
        function loadDashboard() {
            const drivers = db.getDrivers();
            const trucks = db.getTrucks();
            const documents = db.getDocuments();
            
            const activeDrivers = drivers.filter(d => d.status === 'active').length;
            const availableTrucks = trucks.filter(t => t.status === 'available').length;
            const pendingDocs = documents.filter(d => d.status === 'pending').length;

            document.getElementById('stat-drivers').textContent = activeDrivers;
            document.getElementById('stat-trucks').textContent = trucks.length;
            document.getElementById('stat-available').textContent = availableTrucks;
            document.getElementById('stat-pending').textContent = pendingDocs;

            // Check expiring documents
            loadExpiringDocuments();
        }

        function loadExpiringDocuments() {
            const documents = db.getDocuments();
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            const expiring = documents.filter(doc => {
                if (!doc.expiryDate) return false;
                const expiryDate = new Date(doc.expiryDate);
                return expiryDate >= today && expiryDate <= thirtyDaysFromNow;
            });

            const expiringList = document.getElementById('expiring-list');
            
            if (expiring.length === 0) {
                expiringList.innerHTML = `
                    <div class="alert alert-success">
                        <span id="no-alerts">‚úÖ ${currentLanguage === 'es' ? 'No hay documentos pr√≥ximos a vencer' : 'No documents expiring soon'}</span>
                    </div>
                `;
            } else {
                expiringList.innerHTML = expiring.map(doc => {
                    const drivers = db.getDrivers();
                    const trucks = db.getTrucks();
                    let ownerName = '';
                    
                    if (doc.type === 'driver') {
                        const driver = drivers.find(d => d.id === doc.entityId);
                        ownerName = driver ? `${driver.firstName} ${driver.lastName}` : 'N/A';
                    } else {
                        const truck = trucks.find(t => t.id === doc.entityId);
                        ownerName = truck ? truck.number : 'N/A';
                    }

                    return `
                        <div class="alert alert-warning" style="margin-bottom: 10px;">
                            <strong>üìÑ ${doc.name} - ${ownerName}</strong><br>
                            <small>${currentLanguage === 'es' ? 'Vence' : 'Expires'}: ${doc.expiryDate} | ${currentLanguage === 'es' ? 'Categor√≠a' : 'Category'}: ${doc.category}</small>
                        </div>
                    `;
                }).join('');
            }
        }

        // Drivers
        function loadDrivers() {
            const drivers = db.getDrivers();
            const tbody = document.getElementById('drivers-tbody');
            
            if (drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay choferes registrados' : 'No drivers registered'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = drivers.map(driver => `
                <tr>
                    <td>${driver.id}</td>
                    <td>${driver.firstName} ${driver.lastName}</td>
                    <td>${driver.license}</td>
                    <td>${driver.phone}</td>
                    <td>${driver.email || 'N/A'}</td>
                    <td>
                        <span class="badge badge-${driver.status === 'active' ? 'success' : driver.status === 'inactive' ? 'danger' : 'warning'}">
                            ${driver.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : driver.status === 'inactive' ? (currentLanguage === 'es' ? 'Inactivo' : 'Inactive') : (currentLanguage === 'es' ? 'Suspendido' : 'Suspended')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewDriver(${driver.id})" title="${currentLanguage === 'es' ? 'Ver detalles' : 'View details'}">üëÅÔ∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="editDriver(${driver.id})" title="${currentLanguage === 'es' ? 'Editar' : 'Edit'}">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDriver(${driver.id})" title="${currentLanguage === 'es' ? 'Eliminar' : 'Delete'}">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchDrivers() {
            const searchTerm = document.getElementById('driver-search').value.toLowerCase();
            const drivers = db.getDrivers();
            const filtered = drivers.filter(d => 
                d.firstName.toLowerCase().includes(searchTerm) ||
                d.lastName.toLowerCase().includes(searchTerm) ||
                d.license.toLowerCase().includes(searchTerm) ||
                (d.phone && d.phone.includes(searchTerm))
            );

            const tbody = document.getElementById('drivers-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No se encontraron resultados' : 'No results found'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(driver => `
                <tr>
                    <td>${driver.id}</td>
                    <td>${driver.firstName} ${driver.lastName}</td>
                    <td>${driver.license}</td>
                    <td>${driver.phone}</td>
                    <td>${driver.email || 'N/A'}</td>
                    <td>
                        <span class="badge badge-${driver.status === 'active' ? 'success' : 'danger'}">
                            ${driver.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewDriver(${driver.id})">üëÅÔ∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="editDriver(${driver.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDriver(${driver.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openDriverModal() {
            document.getElementById('driver-modal').classList.add('active');
            document.getElementById('driver-form').reset();
        }

        function closeDriverModal() {
            document.getElementById('driver-modal').classList.remove('active');
        }

        function saveDriver(event) {
            event.preventDefault();
            
            const driver = {
                firstName: document.getElementById('driver-first-name').value,
                lastName: document.getElementById('driver-last-name').value,
                phone: document.getElementById('driver-phone').value,
                email: document.getElementById('driver-email').value,
                dob: document.getElementById('driver-dob').value,
                hireDate: document.getElementById('driver-hire-date').value,
                address: document.getElementById('driver-address').value,
                city: document.getElementById('driver-city').value,
                state: document.getElementById('driver-state').value,
                license: document.getElementById('driver-license').value,
                licenseType: document.getElementById('driver-license-type').value,
                licenseExpiry: document.getElementById('driver-license-expiry').value,
                medicalCert: document.getElementById('driver-medical-cert').value,
                emergencyName: document.getElementById('driver-emergency-name').value,
                emergencyPhone: document.getElementById('driver-emergency-phone').value,
                status: document.getElementById('driver-status').value,
                notes: document.getElementById('driver-notes').value
            };

            db.saveDriver(driver);
            closeDriverModal();
            loadDrivers();
            loadDashboard();
            
            alert(currentLanguage === 'es' ? '‚úÖ Chofer agregado correctamente' : '‚úÖ Driver added successfully');
        }

        function viewDriver(id) {
            const driver = db.getDrivers().find(d => d.id === id);
            if (!driver) return;

            document.getElementById('driver-details-name').textContent = `${driver.firstName} ${driver.lastName}`;
            
            // Info tab
            document.getElementById('driver-details-info').innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Nombre Completo' : 'Full Name'}</div>
                        <div class="detail-value">${driver.firstName} ${driver.lastName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Licencia' : 'License'}</div>
                        <div class="detail-value">${driver.license}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Tel√©fono' : 'Phone'}</div>
                        <div class="detail-value">${driver.phone}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${driver.email || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Fecha de Nacimiento' : 'Date of Birth'}</div>
                        <div class="detail-value">${driver.dob || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Fecha de Contrataci√≥n' : 'Hire Date'}</div>
                        <div class="detail-value">${driver.hireDate || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Direcci√≥n' : 'Address'}</div>
                        <div class="detail-value">${driver.address || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Ciudad/Estado' : 'City/State'}</div>
                        <div class="detail-value">${driver.city || 'N/A'}, ${driver.state || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Tipo de Licencia' : 'License Type'}</div>
                        <div class="detail-value">${driver.licenseType || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Venc. Licencia' : 'License Expiry'}</div>
                        <div class="detail-value">${driver.licenseExpiry || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Cert. M√©dico' : 'Medical Cert.'}</div>
                        <div class="detail-value">${driver.medicalCert || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Estado' : 'Status'}</div>
                        <div class="detail-value">
                            <span class="badge badge-${driver.status === 'active' ? 'success' : 'danger'}">
                                ${driver.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                            </span>
                        </div>
                    </div>
                </div>
                ${driver.notes ? `
                    <div style="margin-top: 20px;">
                        <div class="detail-label">${currentLanguage === 'es' ? 'Notas' : 'Notes'}</div>
                        <div class="detail-value" style="margin-top: 10px; padding: 15px; background: var(--light-bg); border-radius: 8px;">
                            ${driver.notes}
                        </div>
                    </div>
                ` : ''}
            `;

            // Assignments tab
            const assignments = db.getAssignments().filter(a => a.driverId === id);
            document.getElementById('driver-details-assignments').innerHTML = assignments.length > 0 ? 
                assignments.map(a => {
                    const truck = db.getTrucks().find(t => t.id === a.truckId);
                    return `
                        <div class="document-item">
                            <div class="document-info">
                                <div class="document-icon">üöõ</div>
                                <div>
                                    <strong>${truck ? truck.number : 'N/A'} - ${truck ? truck.make + ' ' + truck.model : ''}</strong><br>
                                    <small>${currentLanguage === 'es' ? 'Desde' : 'From'}: ${a.startDate} ${a.endDate ? `| ${currentLanguage === 'es' ? 'Hasta' : 'Until'}: ${a.endDate}` : ''}</small>
                                </div>
                            </div>
                            <span class="badge badge-${a.status === 'active' ? 'success' : 'danger'}">
                                ${a.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Finalizado' : 'Ended')}
                            </span>
                        </div>
                    `;
                }).join('') :
                `<p style="text-align: center; padding: 40px;">${currentLanguage === 'es' ? 'No hay asignaciones registradas' : 'No assignments registered'}</p>`;

            // Documents tab
            const documents = db.getDocuments().filter(d => d.type === 'driver' && d.entityId === id);
            document.getElementById('driver-details-documents').innerHTML = documents.length > 0 ?
                documents.map(doc => `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-icon">üìÑ</div>
                            <div>
                                <strong>${doc.name}</strong><br>
                                <small>${doc.category} | ${currentLanguage === 'es' ? 'Cargado' : 'Uploaded'}: ${doc.uploadDate}</small>
                            </div>
                        </div>
                        <span class="badge badge-${doc.status === 'approved' ? 'success' : doc.status === 'rejected' ? 'danger' : 'warning'}">
                            ${doc.status === 'approved' ? (currentLanguage === 'es' ? 'Aprobado' : 'Approved') : doc.status === 'rejected' ? (currentLanguage === 'es' ? 'Rechazado' : 'Rejected') : (currentLanguage === 'es' ? 'Pendiente' : 'Pending')}
                        </span>
                    </div>
                `).join('') :
                `<p style="text-align: center; padding: 40px;">${currentLanguage === 'es' ? 'No hay documentos registrados' : 'No documents registered'}</p>`;

            document.getElementById('driver-details-modal').classList.add('active');
        }

        function closeDriverDetailsModal() {
            document.getElementById('driver-details-modal').classList.remove('active');
        }

        function switchDetailsTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('#driver-details-modal .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#driver-details-modal .tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active to selected tab
            document.getElementById('details-tab-' + tabName).classList.add('active');
            document.getElementById('details-tab-' + tabName + '-content').classList.add('active');
        }

        function editDriver(id) {
            alert(currentLanguage === 'es' ? 'Funci√≥n de edici√≥n en desarrollo' : 'Edit function in development');
        }

        function deleteDriver(id) {
            if (confirm(currentLanguage === 'es' ? '¬øEst√° seguro de eliminar este chofer?' : 'Are you sure you want to delete this driver?')) {
                db.deleteDriver(id);
                loadDrivers();
                loadDashboard();
                alert(currentLanguage === 'es' ? '‚úÖ Chofer eliminado' : '‚úÖ Driver deleted');
            }
        }

        // Trucks
        function loadTrucks() {
            const trucks = db.getTrucks();
            const tbody = document.getElementById('trucks-tbody');
            
            if (trucks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay camiones registrados' : 'No trucks registered'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = trucks.map(truck => `
                <tr>
                    <td>${truck.id}</td>
                    <td>${truck.number}</td>
                    <td>${truck.plate}</td>
                    <td>${truck.make} ${truck.model}</td>
                    <td>${truck.year}</td>
                    <td>
                        <span class="badge badge-${truck.status === 'available' ? 'success' : truck.status === 'assigned' ? 'warning' : 'danger'}">
                            ${truck.status === 'available' ? (currentLanguage === 'es' ? 'Disponible' : 'Available') : 
                              truck.status === 'assigned' ? (currentLanguage === 'es' ? 'Asignado' : 'Assigned') : 
                              truck.status === 'maintenance' ? (currentLanguage === 'es' ? 'Mantenimiento' : 'Maintenance') : 
                              (currentLanguage === 'es' ? 'Fuera de Servicio' : 'Out of Service')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewTruck(${truck.id})">üëÅÔ∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="editTruck(${truck.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTruck(${truck.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchTrucks() {
            const searchTerm = document.getElementById('truck-search').value.toLowerCase();
            const trucks = db.getTrucks();
            const filtered = trucks.filter(t => 
                t.number.toLowerCase().includes(searchTerm) ||
                t.plate.toLowerCase().includes(searchTerm) ||
                t.make.toLowerCase().includes(searchTerm) ||
                t.model.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('trucks-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No se encontraron resultados' : 'No results found'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(truck => `
                <tr>
                    <td>${truck.id}</td>
                    <td>${truck.number}</td>
                    <td>${truck.plate}</td>
                    <td>${truck.make} ${truck.model}</td>
                    <td>${truck.year}</td>
                    <td>
                        <span class="badge badge-${truck.status === 'available' ? 'success' : 'warning'}">
                            ${truck.status === 'available' ? (currentLanguage === 'es' ? 'Disponible' : 'Available') : (currentLanguage === 'es' ? 'Asignado' : 'Assigned')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewTruck(${truck.id})">üëÅÔ∏è</button>
                            <button class="btn btn-primary btn-sm" onclick="editTruck(${truck.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTruck(${truck.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openTruckModal() {
            document.getElementById('truck-modal').classList.add('active');
            document.getElementById('truck-form').reset();
        }

        function closeTruckModal() {
            document.getElementById('truck-modal').classList.remove('active');
        }

        function saveTruck(event) {
            event.preventDefault();
            
            const truck = {
                number: document.getElementById('truck-number').value,
                plate: document.getElementById('truck-plate').value,
                vin: document.getElementById('truck-vin').value,
                make: document.getElementById('truck-make').value,
                model: document.getElementById('truck-model').value,
                year: parseInt(document.getElementById('truck-year').value),
                color: document.getElementById('truck-color').value,
                type: document.getElementById('truck-type').value,
                mileage: document.getElementById('truck-mileage').value,
                lastService: document.getElementById('truck-last-service').value,
                nextService: document.getElementById('truck-next-service').value,
                insuranceExpiry: document.getElementById('truck-insurance-expiry').value,
                inspectionExpiry: document.getElementById('truck-inspection-expiry').value,
                status: document.getElementById('truck-status').value,
                notes: document.getElementById('truck-notes').value
            };

            db.saveTruck(truck);
            closeTruckModal();
            loadTrucks();
            loadDashboard();
            
            alert(currentLanguage === 'es' ? '‚úÖ Cami√≥n agregado correctamente' : '‚úÖ Truck added successfully');
        }

        function viewTruck(id) {
            alert(currentLanguage === 'es' ? 'Ver detalles del cami√≥n' : 'View truck details');
        }

        function editTruck(id) {
            alert(currentLanguage === 'es' ? 'Funci√≥n de edici√≥n en desarrollo' : 'Edit function in development');
        }

        function deleteTruck(id) {
            if (confirm(currentLanguage === 'es' ? '¬øEst√° seguro de eliminar este cami√≥n?' : 'Are you sure you want to delete this truck?')) {
                db.deleteTruck(id);
                loadTrucks();
                loadDashboard();
                alert(currentLanguage === 'es' ? '‚úÖ Cami√≥n eliminado' : '‚úÖ Truck deleted');
            }
        }

        // Assignments
        function loadAssignments() {
            const assignments = db.getAssignments();
            const tbody = document.getElementById('assignments-tbody');
            
            if (assignments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay asignaciones registradas' : 'No assignments registered'}
                        </td>
                    </tr>
                `;
                return;
            }

            const drivers = db.getDrivers();
            const trucks = db.getTrucks();

            tbody.innerHTML = assignments.map(assignment => {
                const driver = drivers.find(d => d.id === assignment.driverId);
                const truck = trucks.find(t => t.id === assignment.truckId);

                return `
                    <tr>
                        <td>${assignment.id}</td>
                        <td>${driver ? driver.firstName + ' ' + driver.lastName : 'N/A'}</td>
                        <td>${truck ? truck.number + ' (' + truck.plate + ')' : 'N/A'}</td>
                        <td>${assignment.startDate}</td>
                        <td>${assignment.endDate || (currentLanguage === 'es' ? 'Actual' : 'Current')}</td>
                        <td>
                            <span class="badge badge-${assignment.status === 'active' ? 'success' : 'danger'}">
                                ${assignment.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Finalizado' : 'Ended')}
                            </span>
                        </td>
                        <td>
                            ${assignment.status === 'active' ? 
                                `<button class="btn btn-danger btn-sm" onclick="endAssignment(${assignment.id})">${currentLanguage === 'es' ? 'Finalizar' : 'End'}</button>` : 
                                '-'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openAssignmentModal() {
            const drivers = db.getDrivers().filter(d => d.status === 'active');
            const trucks = db.getTrucks().filter(t => t.status === 'available');

            const driverSelect = document.getElementById('assignment-driver');
            const truckSelect = document.getElementById('assignment-truck');

            driverSelect.innerHTML = '<option value="">Seleccionar...</option>' + 
                drivers.map(d => `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`).join('');

            truckSelect.innerHTML = '<option value="">Seleccionar...</option>' + 
                trucks.map(t => `<option value="${t.id}">${t.number} - ${t.make} ${t.model}</option>`).join('');

            document.getElementById('assignment-modal').classList.add('active');
            document.getElementById('assignment-form').reset();
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('active');
        }

        function saveAssignment(event) {
            event.preventDefault();
            
            const assignment = {
                driverId: parseInt(document.getElementById('assignment-driver').value),
                truckId: parseInt(document.getElementById('assignment-truck').value),
                startDate: document.getElementById('assignment-start-date').value,
                endDate: document.getElementById('assignment-end-date').value || null,
                notes: document.getElementById('assignment-notes').value,
                status: 'active'
            };

            db.saveAssignment(assignment);
            
            // Update truck status to assigned
            db.updateTruck(assignment.truckId, { status: 'assigned' });

            closeAssignmentModal();
            loadAssignments();
            loadTrucks();
            loadDashboard();
            
            alert(currentLanguage === 'es' ? 
                '‚úÖ Asignaci√≥n creada correctamente' :
                '‚úÖ Assignment created successfully');
        }

        function endAssignment(id) {
            if (confirm(currentLanguage === 'es' ? '¬øFinalizar esta asignaci√≥n?' : 'End this assignment?')) {
                const assignment = db.getAssignments().find(a => a.id === id);
                if (assignment) {
                    db.endAssignment(id);
                    db.updateTruck(assignment.truckId, { status: 'available' });
                    loadAssignments();
                    loadTrucks();
                    alert(currentLanguage === 'es' ? '‚úÖ Asignaci√≥n finalizada' : '‚úÖ Assignment ended');
                }
            }
        }

        // ==================== TRIPS FUNCTIONS ====================
        
        function openTripModal() {
            document.getElementById('trip-modal').classList.add('active');
            loadDriversDropdown();
            document.getElementById('trip-form').reset();
            document.getElementById('trip-distance-display').textContent = '-- mi';
        }

        function closeTripModal() {
            document.getElementById('trip-modal').classList.remove('active');
        }

        function loadDriversDropdown() {
            const drivers = db.getDrivers();
            const select = document.getElementById('trip-driver');
            select.innerHTML = '<option value="">Seleccionar...</option>';
            drivers.forEach(driver => {
                if (driver.status === 'active') {
                    select.innerHTML += `<option value="${driver.id}">${driver.firstName} ${driver.lastName}</option>`;
                }
            });
        }

        function calculateTripDistance() {
            const pickup = document.getElementById('trip-pickup-city').value;
            const destination = document.getElementById('trip-destination').value;
            const display = document.getElementById('trip-distance-display');
            const progress = document.getElementById('route-calc-progress');
            const progressBar = document.getElementById('route-calc-bar');
            const progressText = document.getElementById('route-calc-text');
            
            if (pickup && destination) {
                // Mostrar progress bar
                progress.style.display = 'block';
                display.textContent = '‚è≥';
                display.style.color = '#6b7280';
                
                // Simular c√°lculo con progress bar
                let width = 0;
                const interval = setInterval(() => {
                    width += 20;
                    progressBar.style.width = width + '%';
                    
                    if (width >= 100) {
                        clearInterval(interval);
                        const distance = calculateDistance(pickup, destination);
                        
                        setTimeout(() => {
                            display.textContent = distance;
                            display.style.color = distance === 'Calcular ruta' ? '#f59e0b' : '#10b981';
                            progress.style.display = 'none';
                            progressBar.style.width = '0%';
                        }, 300);
                    }
                }, 150);
            } else {
                display.textContent = '-- mi';
                display.style.color = '#1e40af';
                progress.style.display = 'none';
            }
        }

        function saveTrip(event) {
            event.preventDefault();
            
            const driverId = parseInt(document.getElementById('trip-driver').value);
            const driver = db.getDrivers().find(d => d.id === driverId);
            const pickupCity = document.getElementById('trip-pickup-city').value;
            const destinationCity = document.getElementById('trip-destination').value;
            const distance = calculateDistance(pickupCity, destinationCity);
            const fileInput = document.getElementById('trip-file-upload');
            
            const trip = {
                id: Date.now(),
                driverId: driverId,
                driverName: driver ? `${driver.firstName} ${driver.lastName}` : 'N/A',
                document: document.getElementById('trip-document').value,
                pickupAddress: document.getElementById('trip-pickup-address').value,
                pickupCity: pickupCity,
                destinationCity: destinationCity,
                distance: distance,
                startDate: document.getElementById('trip-start-date').value,
                notes: document.getElementById('trip-notes').value,
                status: 'pending',
                createdAt: new Date().toISOString(),
                hasFile: fileInput.files.length > 0,
                fileName: fileInput.files.length > 0 ? fileInput.files[0].name : null
            };
            
            // Si hay archivo, convertir a base64 para guardar
            if (fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    trip.fileData = e.target.result;
                    saveTripData(trip);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveTripData(trip);
            }
        }

        function saveTripData(trip) {
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            trips.push(trip);
            localStorage.setItem('trips', JSON.stringify(trips));
            
            closeTripModal();
            loadTrips();
            
            alert(currentLanguage === 'es' ?
                `‚úÖ Viaje creado exitosamente!\n\nüöö Chofer: ${trip.driverName}\nüì¶ Carga: ${trip.document}\nüìç Recogida: ${trip.pickupAddress}\nüéØ Destino: ${trip.destinationCity}\nüìè Distancia: ${trip.distance}${trip.hasFile ? '\nüìÑ Documento adjunto: ' + trip.fileName : ''}` :
                `‚úÖ Trip created successfully!\n\nüöö Driver: ${trip.driverName}\nüì¶ Load: ${trip.document}\nüìç Pickup: ${trip.pickupAddress}\nüéØ Destination: ${trip.destinationCity}\nüìè Distance: ${trip.distance}${trip.hasFile ? '\nüìÑ Attached: ' + trip.fileName : ''}`);
        }

        function loadTrips() {
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const tbody = document.getElementById('trips-tbody');
            
            if (trips.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay viajes registrados' : 'No trips registered'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordenar por m√°s reciente
            trips.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            tbody.innerHTML = trips.map(trip => {
                const statusBadge = trip.status === 'completed' ? 'success' : 
                                   trip.status === 'in-progress' ? 'info' : 'warning';
                const statusText = trip.status === 'completed' ? '‚úÖ Completado' : 
                                  trip.status === 'in-progress' ? 'üöö En Ruta' : '‚è≥ Pendiente';
                
                return `
                    <tr>
                        <td>${trip.id}</td>
                        <td><strong>${trip.driverName}</strong></td>
                        <td>üì¶ ${trip.document}</td>
                        <td>
                            <div style="font-size:12px;color:#6b7280;">üìç ${trip.pickupCity}</div>
                            <div style="font-size:11px;">${trip.pickupAddress}</div>
                        </td>
                        <td><strong style="color:#2563eb;">üéØ ${trip.destinationCity}</strong></td>
                        <td><strong style="color:#10b981;font-size:16px;">${trip.distance}</strong></td>
                        <td><span class="badge badge-${statusBadge}">${statusText}</span></td>
                        <td>
                            ${trip.status === 'pending' ? `
                                <button class="btn btn-info btn-sm" onclick="startTrip(${trip.id})">üöö Iniciar</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteTrip(${trip.id})">üóëÔ∏è</button>
                            ` : trip.status === 'in-progress' ? `
                                <button class="btn btn-success btn-sm" onclick="completeTrip(${trip.id})">‚úÖ Completar</button>
                            ` : `
                                <button class="btn btn-danger btn-sm" onclick="deleteTrip(${trip.id})">üóëÔ∏è</button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function startTrip(id) {
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const trip = trips.find(t => t.id === id);
            if (trip) {
                trip.status = 'in-progress';
                trip.startedAt = new Date().toISOString();
                localStorage.setItem('trips', JSON.stringify(trips));
                loadTrips();
                alert(currentLanguage === 'es' ? 'üöö Viaje iniciado' : 'üöö Trip started');
            }
        }

        function completeTrip(id) {
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const trip = trips.find(t => t.id === id);
            if (trip) {
                trip.status = 'completed';
                trip.completedAt = new Date().toISOString();
                localStorage.setItem('trips', JSON.stringify(trips));
                loadTrips();
                alert(currentLanguage === 'es' ? '‚úÖ Viaje completado' : '‚úÖ Trip completed');
            }
        }

        function deleteTrip(id) {
            if (confirm(currentLanguage === 'es' ? '¬øEliminar este viaje?' : 'Delete this trip?')) {
                let trips = JSON.parse(localStorage.getItem('trips') || '[]');
                trips = trips.filter(t => t.id !== id);
                localStorage.setItem('trips', JSON.stringify(trips));
                loadTrips();
            }
        }

        // Documents
        function loadDocuments() {
            const documents = db.getDocuments();
            const documentsList = document.getElementById('documents-list');
            
            if (documents.length === 0) {
                documentsList.innerHTML = `
                    <p style="text-align: center; padding: 40px;">
                        ${currentLanguage === 'es' ? 'No hay documentos registrados' : 'No documents registered'}
                    </p>
                `;
                return;
            }

            const drivers = db.getDrivers();
            const trucks = db.getTrucks();

            documentsList.innerHTML = documents.map(doc => {
                let ownerName = doc.driverName || doc.entityName || 'N/A';
                
                // Informaci√≥n de BOL si aplica
                let bolInfo = '';
                if (doc.category === 'bill' && doc.bolOrigin && doc.bolDestination) {
                    bolInfo = `
                        <div style="margin-top: 8px; padding: 8px; background: #dbeafe; border-radius: 4px; font-size: 13px;">
                            <strong>üìç Ruta:</strong> ${doc.bolOrigin} ‚Üí ${doc.bolDestination}
                            ${doc.bolNumber ? ` | <strong>BOL #:</strong> ${doc.bolNumber}` : ''}
                        </div>
                    `;
                }

                return `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-icon">üìÑ</div>
                            <div style="flex: 1;">
                                <strong>${doc.fileName}</strong><br>
                                <small>
                                    üë§ ${ownerName} | 
                                    üöõ ${doc.truckNumber || 'N/A'} | 
                                    ${doc.category} | 
                                    üìÖ ${doc.uploadDateFormatted || new Date(doc.uploadDate).toLocaleDateString()}
                                </small>
                                ${bolInfo}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="badge badge-${doc.status === 'approved' ? 'success' : doc.status === 'rejected' ? 'danger' : doc.status === 'received' ? 'info' : 'warning'}">
                                ${doc.status === 'approved' ? (currentLanguage === 'es' ? '‚úÖ Aprobado' : '‚úÖ Approved') : 
                                  doc.status === 'rejected' ? (currentLanguage === 'es' ? '‚ùå Rechazado' : '‚ùå Rejected') : 
                                  doc.status === 'received' ? (currentLanguage === 'es' ? 'üì• Recibido' : 'üì• Received') :
                                  (currentLanguage === 'es' ? '‚è≥ Pendiente' : '‚è≥ Pending')}
                            </span>
                            ${doc.status === 'pending' ? `
                                <button class="btn btn-info btn-sm" onclick="markAsReceived(${doc.id})" title="${currentLanguage === 'es' ? 'Marcar como Recibido' : 'Mark as Received'}">
                                    üì• ${currentLanguage === 'es' ? 'Recibido' : 'Received'}
                                </button>
                                <button class="btn btn-success btn-sm" onclick="approveDocument(${doc.id})">${currentLanguage === 'es' ? '‚úì Aprobar' : '‚úì Approve'}</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectDocument(${doc.id})">${currentLanguage === 'es' ? '‚úó Rechazar' : '‚úó Reject'}</button>
                            ` : doc.status === 'received' ? `
                                <button class="btn btn-success btn-sm" onclick="approveDocument(${doc.id})">${currentLanguage === 'es' ? '‚úì Aprobar' : '‚úì Approve'}</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectDocument(${doc.id})">${currentLanguage === 'es' ? '‚úó Rechazar' : '‚úó Reject'}</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterDocuments(filter) {
            // Update active tab
            document.querySelectorAll('#documents-section .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            const documents = db.getDocuments();
            const filtered = filter === 'all' ? documents : documents.filter(d => d.status === filter);
            
            const documentsList = document.getElementById('documents-list');
            const drivers = db.getDrivers();
            const trucks = db.getTrucks();

            if (filtered.length === 0) {
                documentsList.innerHTML = `
                    <p style="text-align: center; padding: 40px;">
                        ${currentLanguage === 'es' ? 'No hay documentos en esta categor√≠a' : 'No documents in this category'}
                    </p>
                `;
                return;
            }

            documentsList.innerHTML = filtered.map(doc => {
                let ownerName = '';
                if (doc.type === 'driver') {
                    const driver = drivers.find(d => d.id === doc.entityId);
                    ownerName = driver ? `${driver.firstName} ${driver.lastName}` : 'N/A';
                } else {
                    const truck = trucks.find(t => t.id === doc.entityId);
                    ownerName = truck ? truck.number : 'N/A';
                }

                return `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-icon">üìÑ</div>
                            <div>
                                <strong>${doc.name}</strong><br>
                                <small>${doc.type === 'driver' ? 'üë§' : 'üöõ'} ${ownerName} | ${doc.category} | ${doc.uploadDate}</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span class="badge badge-${doc.status === 'approved' ? 'success' : doc.status === 'rejected' ? 'danger' : 'warning'}">
                                ${doc.status === 'approved' ? (currentLanguage === 'es' ? 'Aprobado' : 'Approved') : 
                                  doc.status === 'rejected' ? (currentLanguage === 'es' ? 'Rechazado' : 'Rejected') : 
                                  (currentLanguage === 'es' ? 'Pendiente' : 'Pending')}
                            </span>
                            ${doc.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="approveDocument(${doc.id})">${currentLanguage === 'es' ? '‚úì Aprobar' : '‚úì Approve'}</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectDocument(${doc.id})">${currentLanguage === 'es' ? '‚úó Rechazar' : '‚úó Reject'}</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openDocumentModal() {
            document.getElementById('document-modal').classList.add('active');
            document.getElementById('document-form').reset();
            document.getElementById('file-name').textContent = '';
            
            // Handle document type change
            document.getElementById('document-type').addEventListener('change', function() {
                const type = this.value;
                const entitySelect = document.getElementById('document-entity');
                
                if (type === 'driver') {
                    const drivers = db.getDrivers();
                    entitySelect.innerHTML = '<option value="">Seleccionar...</option>' +
                        drivers.map(d => `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`).join('');
                } else if (type === 'truck') {
                    const trucks = db.getTrucks();
                    entitySelect.innerHTML = '<option value="">Seleccionar...</option>' +
                        trucks.map(t => `<option value="${t.id}">${t.number} - ${t.plate}</option>`).join('');
                }
            });

            // Handle file upload
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('document-file');
            
            uploadArea.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    document.getElementById('file-name').textContent = `üìé ${e.target.files[0].name}`;
                }
            };

            // Drag and drop
            uploadArea.ondragover = (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            };
            
            uploadArea.ondragleave = () => {
                uploadArea.classList.remove('drag-over');
            };
            
            uploadArea.ondrop = (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    document.getElementById('file-name').textContent = `üìé ${e.dataTransfer.files[0].name}`;
                }
            };
        }

        function closeDocumentModal() {
            document.getElementById('document-modal').classList.remove('active');
        }

        function saveDocument(event) {
            event.preventDefault();
            
            const document = {
                type: document.getElementById('document-type').value,
                entityId: parseInt(document.getElementById('document-entity').value),
                category: document.getElementById('document-category').value,
                name: document.getElementById('document-name').value,
                expiryDate: document.getElementById('document-expiry').value,
                fileName: document.getElementById('document-file').files[0]?.name || ''
            };

            db.saveDocument(document);
            closeDocumentModal();
            loadDocuments();
            loadDashboard();
            
            alert(currentLanguage === 'es' ? '‚úÖ Documento subido correctamente' : '‚úÖ Document uploaded successfully');
        }

        function markAsReceived(id) {
            db.updateDocument(id, { status: 'received' });
            loadDocuments();
            alert(currentLanguage === 'es' ? 
                'üì• Documento marcado como Recibido' : 
                'üì• Document marked as Received');
        }

        function approveDocument(id) {
            db.updateDocumentStatus(id, 'approved');
            loadDocuments();
            loadDashboard();
            alert(currentLanguage === 'es' ? '‚úÖ Documento aprobado' : '‚úÖ Document approved');
        }

        function rejectDocument(id) {
            const reason = prompt(currentLanguage === 'es' ? 'Motivo del rechazo:' : 'Rejection reason:');
            if (reason) {
                db.updateDocumentStatus(id, 'rejected', reason);
                loadDocuments();
                loadDashboard();
                alert(currentLanguage === 'es' ? '‚úÖ Documento rechazado' : '‚úÖ Document rejected');
            }
        }

        // Reports
        function generateReport(type) {
            alert(currentLanguage === 'es' ? `Generando reporte de ${type}...` : `Generating ${type} report...`);
        }

        // Brokers & Dispatch
        function loadBrokers() {
            const brokers = db.getBrokers();
            const tbody = document.getElementById('brokers-tbody');
            
            if (brokers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay brokers/dispatchers registrados' : 'No brokers/dispatchers registered'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = brokers.map(broker => `
                <tr>
                    <td>${broker.id}</td>
                    <td>
                        <span class="badge badge-${broker.type === 'broker' ? 'primary' : broker.type === 'dispatch' ? 'warning' : 'success'}">
                            ${broker.type === 'broker' ? 'Broker' : broker.type === 'dispatch' ? 'Dispatch' : (currentLanguage === 'es' ? 'Ambos' : 'Both')}
                        </span>
                    </td>
                    <td>${broker.company}</td>
                    <td>${broker.contactName}</td>
                    <td>${broker.email}</td>
                    <td>${broker.phone}</td>
                    <td>
                        <span class="badge badge-${broker.status === 'active' ? 'success' : 'danger'}">
                            ${broker.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewBroker(${broker.id})" title="${currentLanguage === 'es' ? 'Ver detalles' : 'View details'}">üëÅÔ∏è</button>
                            <button class="btn btn-success btn-sm" onclick="openSendToSingleBroker(${broker.id})" title="${currentLanguage === 'es' ? 'Enviar documentos' : 'Send documents'}">üì§</button>
                            <button class="btn btn-primary btn-sm" onclick="editBroker(${broker.id})" title="${currentLanguage === 'es' ? 'Editar' : 'Edit'}">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBroker(${broker.id})" title="${currentLanguage === 'es' ? 'Eliminar' : 'Delete'}">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchBrokers() {
            const searchTerm = document.getElementById('broker-search').value.toLowerCase();
            const brokers = db.getBrokers();
            const filtered = brokers.filter(b => 
                b.company.toLowerCase().includes(searchTerm) ||
                b.contactName.toLowerCase().includes(searchTerm) ||
                b.email.toLowerCase().includes(searchTerm) ||
                (b.phone && b.phone.includes(searchTerm))
            );

            const tbody = document.getElementById('brokers-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No se encontraron resultados' : 'No results found'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(broker => `
                <tr>
                    <td>${broker.id}</td>
                    <td>
                        <span class="badge badge-${broker.type === 'broker' ? 'primary' : broker.type === 'dispatch' ? 'warning' : 'success'}">
                            ${broker.type === 'broker' ? 'Broker' : broker.type === 'dispatch' ? 'Dispatch' : (currentLanguage === 'es' ? 'Ambos' : 'Both')}
                        </span>
                    </td>
                    <td>${broker.company}</td>
                    <td>${broker.contactName}</td>
                    <td>${broker.email}</td>
                    <td>${broker.phone}</td>
                    <td>
                        <span class="badge badge-${broker.status === 'active' ? 'success' : 'danger'}">
                            ${broker.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="viewBroker(${broker.id})">üëÅÔ∏è</button>
                            <button class="btn btn-success btn-sm" onclick="openSendToSingleBroker(${broker.id})">üì§</button>
                            <button class="btn btn-primary btn-sm" onclick="editBroker(${broker.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBroker(${broker.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openBrokerModal() {
            document.getElementById('broker-modal').classList.add('active');
            document.getElementById('broker-form').reset();
        }

        function closeBrokerModal() {
            document.getElementById('broker-modal').classList.remove('active');
        }

        function saveBroker(event) {
            event.preventDefault();
            
            const broker = {
                type: document.getElementById('broker-type').value,
                company: document.getElementById('broker-company').value,
                contactName: document.getElementById('broker-contact-name').value,
                position: document.getElementById('broker-position').value,
                email: document.getElementById('broker-email').value,
                phone: document.getElementById('broker-phone').value,
                phone2: document.getElementById('broker-phone2').value,
                fax: document.getElementById('broker-fax').value,
                address: document.getElementById('broker-address').value,
                city: document.getElementById('broker-city').value,
                state: document.getElementById('broker-state').value,
                zip: document.getElementById('broker-zip').value,
                country: document.getElementById('broker-country').value,
                mc: document.getElementById('broker-mc').value,
                dot: document.getElementById('broker-dot').value,
                ein: document.getElementById('broker-ein').value,
                paymentTerms: document.getElementById('broker-payment-terms').value,
                status: document.getElementById('broker-status').value,
                notes: document.getElementById('broker-notes').value
            };

            db.saveBroker(broker);
            closeBrokerModal();
            loadBrokers();
            
            alert(currentLanguage === 'es' ? '‚úÖ Broker/Dispatch agregado correctamente' : '‚úÖ Broker/Dispatch added successfully');
        }

        function viewBroker(id) {
            const broker = db.getBrokers().find(b => b.id === id);
            if (!broker) return;

            const typeLabel = broker.type === 'broker' ? 'Broker' : broker.type === 'dispatch' ? 'Dispatch' : (currentLanguage === 'es' ? 'Ambos' : 'Both');
            
            const details = `
                <div style="padding: 20px;">
                    <h3>${broker.company}</h3>
                    <div style="margin-top: 20px;">
                        <p><strong>${currentLanguage === 'es' ? 'Tipo' : 'Type'}:</strong> ${typeLabel}</p>
                        <p><strong>${currentLanguage === 'es' ? 'Contacto' : 'Contact'}:</strong> ${broker.contactName} ${broker.position ? '(' + broker.position + ')' : ''}</p>
                        <p><strong>Email:</strong> ${broker.email}</p>
                        <p><strong>${currentLanguage === 'es' ? 'Tel√©fono' : 'Phone'}:</strong> ${broker.phone}</p>
                        ${broker.phone2 ? `<p><strong>${currentLanguage === 'es' ? 'Tel√©fono 2' : 'Phone 2'}:</strong> ${broker.phone2}</p>` : ''}
                        ${broker.address ? `<p><strong>${currentLanguage === 'es' ? 'Direcci√≥n' : 'Address'}:</strong> ${broker.address}, ${broker.city}, ${broker.state} ${broker.zip}</p>` : ''}
                        ${broker.mc ? `<p><strong>MC Number:</strong> ${broker.mc}</p>` : ''}
                        ${broker.dot ? `<p><strong>DOT Number:</strong> ${broker.dot}</p>` : ''}
                        ${broker.ein ? `<p><strong>EIN:</strong> ${broker.ein}</p>` : ''}
                        ${broker.paymentTerms ? `<p><strong>${currentLanguage === 'es' ? 'T√©rminos de Pago' : 'Payment Terms'}:</strong> ${broker.paymentTerms}</p>` : ''}
                        ${broker.notes ? `<p><strong>${currentLanguage === 'es' ? 'Notas' : 'Notes'}:</strong> ${broker.notes}</p>` : ''}
                    </div>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;">${currentLanguage === 'es' ? 'Cerrar' : 'Close'}</button>
                </div>
            `;
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'modal active';
            detailsDiv.innerHTML = `<div class="modal-content">${details}</div>`;
            document.body.appendChild(detailsDiv);
        }

        function editBroker(id) {
            alert(currentLanguage === 'es' ? 'Funci√≥n de edici√≥n en desarrollo' : 'Edit function in development');
        }

        function deleteBroker(id) {
            if (confirm(currentLanguage === 'es' ? '¬øEst√° seguro de eliminar este broker/dispatch?' : 'Are you sure you want to delete this broker/dispatch?')) {
                db.deleteBroker(id);
                loadBrokers();
                alert(currentLanguage === 'es' ? '‚úÖ Broker/Dispatch eliminado' : '‚úÖ Broker/Dispatch deleted');
            }
        }

        // Send Documents to Brokers
        function openSendDocumentsModal() {
            const brokers = db.getBrokers().filter(b => b.status === 'active');
            const select = document.getElementById('send-to-broker');
            
            select.innerHTML = '<option value="">Seleccionar Broker/Dispatch...</option>' +
                brokers.map(b => `<option value="${b.id}">${b.company} - ${b.contactName}</option>`).join('');

            loadDocumentsChecklist();
            document.getElementById('send-documents-modal').classList.add('active');
        }

        function openSendToSingleBroker(brokerId) {
            openSendDocumentsModal();
            document.getElementById('send-to-broker').value = brokerId;
            updateBrokerInfo();
        }

        function closeSendDocumentsModal() {
            document.getElementById('send-documents-modal').classList.remove('active');
            document.getElementById('send-documents-form').reset();
        }

        function updateBrokerInfo() {
            const brokerId = parseInt(document.getElementById('send-to-broker').value);
            const brokerInfoDisplay = document.getElementById('broker-info-display');
            
            if (brokerId) {
                const broker = db.getBrokers().find(b => b.id === brokerId);
                if (broker) {
                    document.getElementById('broker-info-email').textContent = broker.email;
                    document.getElementById('broker-info-phone').textContent = broker.phone;
                    brokerInfoDisplay.style.display = 'block';
                }
            } else {
                brokerInfoDisplay.style.display = 'none';
            }
        }

        function loadDocumentsChecklist() {
            const documents = db.getDocuments().filter(d => d.status === 'approved');
            const checklist = document.getElementById('documents-checklist');
            
            if (documents.length === 0) {
                checklist.innerHTML = `
                    <p style="text-align: center; padding: 20px; color: var(--text-light);">
                        ${currentLanguage === 'es' ? 'No hay documentos aprobados disponibles para enviar' : 'No approved documents available to send'}
                    </p>
                `;
                return;
            }

            const drivers = db.getDrivers();
            const trucks = db.getTrucks();

            checklist.innerHTML = documents.map(doc => {
                let ownerName = '';
                if (doc.type === 'driver') {
                    const driver = drivers.find(d => d.id === doc.entityId);
                    ownerName = driver ? `${driver.firstName} ${driver.lastName}` : 'N/A';
                } else {
                    const truck = trucks.find(t => t.id === doc.entityId);
                    ownerName = truck ? truck.number : 'N/A';
                }

                return `
                    <div style="padding: 10px; background: var(--light-bg); border-radius: 8px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" name="documents[]" value="${doc.id}" style="margin-right: 10px; width: 18px; height: 18px;">
                            <div>
                                <strong>üìÑ ${doc.name}</strong><br>
                                <small style="color: var(--text-light);">
                                    ${doc.type === 'driver' ? 'üë§' : 'üöõ'} ${ownerName} | ${doc.category} | ${doc.uploadDate}
                                </small>
                            </div>
                        </label>
                    </div>
                `;
            }).join('');
        }

        function sendDocumentsToBroker(event) {
            event.preventDefault();
            
            const brokerId = parseInt(document.getElementById('send-to-broker').value);
            const message = document.getElementById('send-message').value;
            const checkboxes = document.querySelectorAll('input[name="documents[]"]:checked');
            
            if (checkboxes.length === 0) {
                alert(currentLanguage === 'es' ? 'Por favor seleccione al menos un documento' : 'Please select at least one document');
                return;
            }

            const documentIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const broker = db.getBrokers().find(b => b.id === brokerId);
            
            const sentDoc = {
                brokerId: brokerId,
                brokerName: broker.company,
                brokerEmail: broker.email,
                documentIds: documentIds,
                message: message,
                sentDate: new Date().toISOString().split('T')[0]
            };

            db.saveSentDocument(sentDoc);
            closeSendDocumentsModal();
            
            const docCount = documentIds.length;
            alert(currentLanguage === 'es' ? 
                `‚úÖ ${docCount} documento(s) enviado(s) a ${broker.company}\n\nEn una versi√≥n con backend, los documentos se enviar√≠an por email a: ${broker.email}` :
                `‚úÖ ${docCount} document(s) sent to ${broker.company}\n\nIn a backend version, documents would be emailed to: ${broker.email}`
            );
        }




        // Authentication Functions
        // User Management Functions (Admin Only)
        function loadUsers() {
            if (currentUser.role !== 'admin') {
                alert(currentLanguage === 'es' ? 
                    'No tienes permisos para acceder a esta secci√≥n' : 
                    'You do not have permission to access this section');
                showSection('dashboard');
                return;
            }

            const users = db.getUsers();
            const tbody = document.getElementById('users-tbody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No hay usuarios registrados' : 'No users registered'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'user' ? 'primary' : 'warning'}">
                            ${user.role === 'admin' ? (currentLanguage === 'es' ? 'Admin' : 'Admin') :
                              user.role === 'user' ? (currentLanguage === 'es' ? 'Usuario' : 'User') :
                              (currentLanguage === 'es' ? 'Chofer' : 'Driver')}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${user.status === 'active' ? 'success' : 'danger'}">
                            ${user.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${user.id !== currentUser.id ? `
                                <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})" title="${currentLanguage === 'es' ? 'Editar' : 'Edit'}">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})" title="${currentLanguage === 'es' ? 'Eliminar' : 'Delete'}">üóëÔ∏è</button>
                            ` : `
                                <span style="color: var(--text-light); font-size: 12px;">${currentLanguage === 'es' ? '(T√∫)' : '(You)'}</span>
                            `}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const users = db.getUsers();
            const filtered = users.filter(u => 
                u.name.toLowerCase().includes(searchTerm) ||
                u.username.toLowerCase().includes(searchTerm) ||
                u.email.toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('users-tbody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            ${currentLanguage === 'es' ? 'No se encontraron resultados' : 'No results found'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'user' ? 'primary' : 'warning'}">
                            ${user.role === 'admin' ? 'Admin' : user.role === 'user' ? 'Usuario' : 'Chofer'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${user.status === 'active' ? 'success' : 'danger'}">
                            ${user.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') : (currentLanguage === 'es' ? 'Inactivo' : 'Inactive')}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${user.id !== currentUser.id ? `
                                <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">üóëÔ∏è</button>
                            ` : `
                                <span style="color: var(--text-light); font-size: 12px;">(T√∫)</span>
                            `}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openUserModal() {
            if (currentUser.role !== 'admin') {
                alert(currentLanguage === 'es' ? 
                    'Solo los administradores pueden agregar usuarios' : 
                    'Only administrators can add users');
                return;
            }
            
            // Cargar choferes en el dropdown
            loadDriversForUserCreation();
            
            // Verificar si ya existe un admin
            const users = db.getUsers();
            const adminExists = users.some(u => u.role === 'admin');
            
            // Configurar el select de roles
            const roleSelect = document.getElementById('user-role-select');
            if (adminExists) {
                // Si ya existe admin, solo mostrar usuario y chofer
                roleSelect.innerHTML = `
                    <option value="">Seleccionar...</option>
                    <option value="user">Usuario</option>
                    <option value="driver">Chofer</option>
                `;
            } else {
                // Si no existe admin, mostrar todas las opciones
                roleSelect.innerHTML = `
                    <option value="">Seleccionar...</option>
                    <option value="admin">Administrador</option>
                    <option value="user">Usuario</option>
                    <option value="driver">Chofer</option>
                `;
            }
            
            document.getElementById('user-modal').classList.add('active');
            document.getElementById('user-form').reset();
        }

        function closeUserModal() {
            document.getElementById('user-modal').classList.remove('active');
            resetUserForm();
        }

        function loadDriversForUserCreation() {
            const drivers = db.getDrivers();
            const select = document.getElementById('user-driver-select');
            
            select.innerHTML = '<option value="">Seleccionar chofer del sistema...</option>';
            
            drivers.forEach(driver => {
                select.innerHTML += `<option value="${driver.id}">${driver.firstName} ${driver.lastName}</option>`;
            });
        }

        function fillUserDataFromDriver() {
            const driverId = parseInt(document.getElementById('user-driver-select').value);
            
            if (!driverId) {
                // Limpiar campos si no hay selecci√≥n
                document.getElementById('user-name-input').value = '';
                document.getElementById('user-email').value = '';
                document.getElementById('user-phone').value = '';
                return;
            }
            
            const drivers = db.getDrivers();
            const driver = drivers.find(d => d.id === driverId);
            
            if (driver) {
                // Llenar datos autom√°ticamente
                document.getElementById('user-name-input').value = `${driver.firstName} ${driver.lastName}`;
                document.getElementById('user-email').value = driver.email || '';
                document.getElementById('user-phone').value = driver.phone || '';
                
                // Sugerir username basado en el nombre
                const suggestedUsername = (driver.firstName.toLowerCase() + '.' + driver.lastName.toLowerCase()).replace(/\s/g, '');
                document.getElementById('user-username').placeholder = `Sugerencia: ${suggestedUsername}`;
            }
        }

        function saveUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name-input').value;
            const username = document.getElementById('user-username').value;
            const email = document.getElementById('user-email').value;
            const phone = document.getElementById('user-phone').value;
            const password = document.getElementById('user-password').value;
            const password2 = document.getElementById('user-password2').value;
            const role = document.getElementById('user-role-select').value;
            const status = document.getElementById('user-status').value;

            if (password !== password2) {
                alert(currentLanguage === 'es' ? 
                    'Las contrase√±as no coinciden' : 
                    'Passwords do not match');
                return;
            }

            if (db.getUserByUsername(username)) {
                alert(currentLanguage === 'es' ? 
                    'El usuario ya existe' : 
                    'Username already exists');
                return;
            }

            const newUser = {
                name: name,
                username: username,
                email: email,
                phone: phone,
                password: password,
                role: role,
                status: status
            };

            db.saveUser(newUser);
            closeUserModal();
            loadUsers();
            
            alert(currentLanguage === 'es' ? 
                '‚úÖ Usuario agregado correctamente' : 
                '‚úÖ User added successfully');
        }

        function editUser(id) {
            const user = db.getUsers().find(u => u.id === id);
            if (!user) {
                alert(currentLanguage === 'es' ? 'Usuario no encontrado' : 'User not found');
                return;
            }
            
            // Abrir modal en modo edici√≥n
            document.getElementById('modal-title-user').textContent = 
                currentLanguage === 'es' ? 'Editar Usuario' : 'Edit User';
            
            // Llenar el formulario con los datos actuales
            document.getElementById('user-name-input').value = user.name;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-username').disabled = true; // No permitir cambiar username
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-phone').value = user.phone || '';
            
            // Hacer que las contrase√±as sean opcionales en edici√≥n
            document.getElementById('user-password').required = false;
            document.getElementById('user-password2').required = false;
            document.getElementById('user-password').placeholder = 
                currentLanguage === 'es' ? 'Dejar vac√≠o para mantener actual' : 'Leave empty to keep current';
            document.getElementById('user-password2').placeholder = 
                currentLanguage === 'es' ? 'Dejar vac√≠o para mantener actual' : 'Leave empty to keep current';
            
            // Configurar roles
            const users = db.getUsers();
            const adminExists = users.some(u => u.role === 'admin' && u.id !== id);
            const roleSelect = document.getElementById('user-role-select');
            
            if (user.role === 'admin') {
                // Si es el admin actual, no permitir cambiar rol
                roleSelect.innerHTML = `<option value="admin">Administrador</option>`;
                roleSelect.disabled = true;
            } else if (adminExists) {
                roleSelect.innerHTML = `
                    <option value="">Seleccionar...</option>
                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuario</option>
                    <option value="driver" ${user.role === 'driver' ? 'selected' : ''}>Chofer</option>
                `;
                roleSelect.disabled = false;
            } else {
                roleSelect.innerHTML = `
                    <option value="">Seleccionar...</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuario</option>
                    <option value="driver" ${user.role === 'driver' ? 'selected' : ''}>Chofer</option>
                `;
                roleSelect.disabled = false;
            }
            
            document.getElementById('user-status').value = user.status;
            
            // Cambiar el evento del formulario para actualizar en lugar de crear
            const form = document.getElementById('user-form');
            form.onsubmit = function(e) {
                e.preventDefault();
                updateUserData(id);
            };
            
            document.getElementById('user-modal').classList.add('active');
        }

        function updateUserData(id) {
            const name = document.getElementById('user-name-input').value;
            const email = document.getElementById('user-email').value;
            const phone = document.getElementById('user-phone').value;
            const password = document.getElementById('user-password').value;
            const password2 = document.getElementById('user-password2').value;
            const role = document.getElementById('user-role-select').value;
            const status = document.getElementById('user-status').value;

            // Validar contrase√±as si se proporcionaron
            if (password || password2) {
                if (password !== password2) {
                    alert(currentLanguage === 'es' ? 
                        'Las contrase√±as no coinciden' : 
                        'Passwords do not match');
                    return;
                }
            }

            const updateData = {
                name: name,
                email: email,
                phone: phone,
                role: role,
                status: status
            };

            // Solo actualizar contrase√±a si se proporcion√≥ una nueva
            if (password) {
                updateData.password = password;
            }

            db.updateUser(id, updateData);
            closeUserModal();
            loadUsers();
            
            alert(currentLanguage === 'es' ? 
                '‚úÖ Usuario actualizado correctamente' : 
                '‚úÖ User updated successfully');
            
            // Restaurar el formulario al modo creaci√≥n
            resetUserForm();
        }

        function resetUserForm() {
            const form = document.getElementById('user-form');
            form.reset();
            form.onsubmit = saveUser;
            
            document.getElementById('modal-title-user').textContent = 
                currentLanguage === 'es' ? 'Agregar Usuario' : 'Add User';
            
            // Limpiar dropdown de choferes
            document.getElementById('user-driver-select').value = '';
            document.getElementById('user-name-input').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-phone').value = '';
            
            document.getElementById('user-username').disabled = false;
            document.getElementById('user-password').required = true;
            document.getElementById('user-password2').required = true;
            document.getElementById('user-password').placeholder = 'Contrase√±a *';
            document.getElementById('user-password2').placeholder = 'Confirmar Contrase√±a *';
            document.getElementById('user-role-select').disabled = false;
        }

        function deleteUser(id) {
            if (id === currentUser.id) {
                alert(currentLanguage === 'es' ? 
                    'No puedes eliminar tu propio usuario' : 
                    'You cannot delete your own user');
                return;
            }

            if (confirm(currentLanguage === 'es' ? 
                '¬øEst√° seguro de eliminar este usuario?' : 
                'Are you sure you want to delete this user?')) {
                db.deleteUser(id);
                loadUsers();
                alert(currentLanguage === 'es' ? 
                    '‚úÖ Usuario eliminado' : 
                    '‚úÖ User deleted');
            }
        }

        function updateMenuByRole() {
            // Only admins can see user management
            const usersMenuItem = document.querySelector('[onclick*="users"]');
            
            if (currentUser.role === 'admin') {
                // Admin sees everything - add Users menu if not exists
                if (!usersMenuItem) {
                    const reportsMenuItem = document.querySelector('[onclick*="reports"]');
                    if (reportsMenuItem) {
                        const userMenuItem = document.createElement('div');
                        userMenuItem.className = 'menu-item';
                        userMenuItem.setAttribute('onclick', "showSection('users')");
                        userMenuItem.innerHTML = `
                            <span class="icon">üë•</span>
                            <span id="menu-users">${currentLanguage === 'es' ? 'Usuarios' : 'Users'}</span>
                        `;
                        reportsMenuItem.parentNode.insertBefore(userMenuItem, reportsMenuItem.nextSibling);
                    }
                }
            } else {
                // Non-admins: hide users menu if exists
                if (usersMenuItem) {
                    usersMenuItem.style.display = 'none';
                }
            }

            // Drivers have limited access
            if (currentUser.role === 'driver') {
                const restrictedSections = ['trucks', 'assignments', 'brokers', 'company', 'reports'];
                restrictedSections.forEach(section => {
                    const menuItem = document.querySelector(`[onclick*="${section}"]`);
                    if (menuItem) {
                        menuItem.style.display = 'none';
                    }
                });
            }
        }

        // Company Management
        function loadCompanyInfo() {
            const company = db.getCompany();
            
            document.getElementById('company-name').value = company.name || '';
            document.getElementById('company-legal-name').value = company.legalName || '';
            document.getElementById('company-tax-id').value = company.taxId || '';
            document.getElementById('company-mc-number').value = company.mcNumber || '';
            document.getElementById('company-dot-number').value = company.dotNumber || '';
            document.getElementById('company-usdot').value = company.usdot || '';
            document.getElementById('company-phone').value = company.phone || '';
            document.getElementById('company-phone2').value = company.phone2 || '';
            document.getElementById('company-email').value = company.email || '';
            document.getElementById('company-website').value = company.website || '';
            document.getElementById('company-fax').value = company.fax || '';
            document.getElementById('company-address').value = company.address || '';
            document.getElementById('company-city').value = company.city || '';
            document.getElementById('company-state').value = company.state || '';
            document.getElementById('company-zip').value = company.zip || '';
            document.getElementById('company-country').value = company.country || 'USA';
            document.getElementById('company-founded').value = company.founded || '';
            document.getElementById('company-employees').value = company.employees || '';
            document.getElementById('company-fleet-size').value = company.fleetSize || '';
            document.getElementById('company-currency').value = company.currency || 'USD';
            document.getElementById('company-description').value = company.description || '';
            
            if (company.logo) {
                document.getElementById('logo-image').src = company.logo;
                document.getElementById('logo-image').style.display = 'block';
                document.getElementById('logo-placeholder').style.display = 'none';
            }
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logo-image').src = e.target.result;
                    document.getElementById('logo-image').style.display = 'block';
                    document.getElementById('logo-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            document.getElementById('logo-image').src = '';
            document.getElementById('logo-image').style.display = 'none';
            document.getElementById('logo-placeholder').style.display = 'flex';
            document.getElementById('company-logo-upload').value = '';
        }

        // Theme Functions
        const themes = {
            blue: {primary:'#2563eb',secondary:'#1e40af'},
            green: {primary:'#10b981',secondary:'#059669'},
            purple: {primary:'#8b5cf6',secondary:'#7c3aed'},
            red: {primary:'#ef4444',secondary:'#dc2626'},
            orange: {primary:'#f97316',secondary:'#ea580c'},
            teal: {primary:'#14b8a6',secondary:'#0d9488'},
            dark: {primary:'#374151',secondary:'#1f2937'}
        };

        function changeTheme() {
            const selected = document.getElementById('theme-color').value;
            const theme = themes[selected];
            if (theme) {
                document.documentElement.style.setProperty('--primary-color', theme.primary);
                document.documentElement.style.setProperty('--secondary-color', theme.secondary);
                localStorage.setItem('theme', selected);
            }
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'blue';
            document.getElementById('theme-color').value = saved;
            changeTheme();
        }

        function saveCompanyInfo() {
            const company = {
                name: document.getElementById('company-name').value,
                legalName: document.getElementById('company-legal-name').value,
                taxId: document.getElementById('company-tax-id').value,
                mcNumber: document.getElementById('company-mc-number').value,
                dotNumber: document.getElementById('company-dot-number').value,
                usdot: document.getElementById('company-usdot').value,
                phone: document.getElementById('company-phone').value,
                phone2: document.getElementById('company-phone2').value,
                email: document.getElementById('company-email').value,
                website: document.getElementById('company-website').value,
                fax: document.getElementById('company-fax').value,
                address: document.getElementById('company-address').value,
                city: document.getElementById('company-city').value,
                state: document.getElementById('company-state').value,
                zip: document.getElementById('company-zip').value,
                country: document.getElementById('company-country').value,
                logo: document.getElementById('logo-image').src || '',
                founded: document.getElementById('company-founded').value,
                employees: document.getElementById('company-employees').value,
                fleetSize: document.getElementById('company-fleet-size').value,
                currency: document.getElementById('company-currency').value,
                description: document.getElementById('company-description').value
            };

            db.saveCompany(company);
            updateCompanyBranding();
            
            alert(currentLanguage === 'es' ? 
                '‚úÖ Informaci√≥n de la empresa guardada correctamente' : 
                '‚úÖ Company information saved successfully');
        }

        function updateCompanyBranding() {
            const company = db.getCompany();
            
            // Update sidebar
            const sidebarLogo = document.getElementById('company-logo-sidebar');
            if (company.logo) {
                sidebarLogo.innerHTML = `<img src="${company.logo}" alt="Logo" style="max-width: 100%; max-height: 60px; object-fit: contain;">`;
            } else {
                sidebarLogo.textContent = company.name || 'üöõ Fleet Manager';
            }
            
            // Update login screen
            const loginLogo = document.getElementById('company-logo-login');
            if (company.logo) {
                loginLogo.innerHTML = `<img src="${company.logo}" alt="Logo" style="max-width: 150px; max-height: 150px; object-fit: contain;">`;
            } else {
                loginLogo.textContent = 'üöõ';
            }
            
            document.getElementById('company-name-login').textContent = company.name || 'Sistema de Gesti√≥n';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar tema guardado
            loadTheme();
            
            // Check if user is logged in
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('login-screen').classList.add('hidden');
                
                // Verificar si es chofer
                if (currentUser.role === 'driver') {
                    loadDriverInterface();
                    return;
                }
                
                // Si no es chofer, cargar interfaz normal
                document.getElementById('main-app').style.display = 'flex';
                
                // Update user info
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-role-display').textContent = 
                    currentUser.role === 'admin' ? 'Administrador' :
                    currentUser.role === 'user' ? 'Usuario' : 'Chofer';
                
                const avatar = currentUser.role === 'admin' ? 'üë®‚Äçüíº' : 
                              currentUser.role === 'user' ? 'üë§' : 'üë®‚Äç‚úàÔ∏è';
                document.getElementById('user-avatar').textContent = avatar;
                
                updateCompanyBranding();
                updateMenuByRole();
                loadDashboard();
                updateTexts();
            } else {
                updateCompanyBranding();
            }
        });

        // Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            
            const progressContainer = document.getElementById('progress-container');
            const loginBtn = document.getElementById('login-btn');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (loginBtn) loginBtn.disabled = true;
            
            updateProgress(30, 'Validando...');
            
            setTimeout(() => {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const user = db.validateLogin(username, password);
                
                if (user) {
                    updateProgress(70, 'Iniciando sistema...');
                    
                    setTimeout(() => {
                        currentUser = user;
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        
                        const loginScreen = document.getElementById('login-screen');
                        if (loginScreen) loginScreen.classList.add('hidden');
                        
                        // Verificar si es chofer
                        if (user.role === 'driver') {
                            updateProgress(100, '‚úÖ ¬°Bienvenido!');
                            setTimeout(() => {
                                if (progressContainer) progressContainer.style.display = 'none';
                                if (loginBtn) loginBtn.disabled = false;
                                loadDriverInterface();
                            }, 500);
                            return;
                        }
                        
                        // Interfaz normal
                        const mainApp = document.getElementById('main-app');
                        if (mainApp) {
                            mainApp.style.display = 'flex';
                            mainApp.style.visibility = 'visible';
                            mainApp.style.opacity = '1';
                        }
                        
                        document.getElementById('user-name').textContent = currentUser.name;
                        document.getElementById('user-role-display').textContent = 
                            currentUser.role === 'admin' ? (currentLanguage === 'es' ? 'Administrador' : 'Administrator') :
                            currentUser.role === 'user' ? (currentLanguage === 'es' ? 'Usuario' : 'User') :
                            (currentLanguage === 'es' ? 'Chofer' : 'Driver');
                        
                        const avatar = currentUser.role === 'admin' ? 'üë®‚Äçüíº' : 
                                      currentUser.role === 'user' ? 'üë§' : 'üë®‚Äç‚úàÔ∏è';
                        document.getElementById('user-avatar').textContent = avatar;
                        
                        updateProgress(100, '‚úÖ Completado');
                        
                        updateCompanyBranding();
                        updateMenuByRole();
                        loadDashboard();
                        updateTexts();
                        
                        setTimeout(() => {
                            if (progressContainer) progressContainer.style.display = 'none';
                            if (loginBtn) loginBtn.disabled = false;
                        }, 500);
                    }, 300);
                } else {
                    if (progressContainer) progressContainer.style.display = 'none';
                    if (loginBtn) loginBtn.disabled = false;
                    alert(currentLanguage === 'es' ? 
                        'Usuario o contrase√±a incorrectos' : 
                        'Invalid username or password');
                }
            }, 300);
        }

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            }
            
            if (progressText) {
                progressText.textContent = text;
            }
        }

        function handleLogout() {
            if (confirm(currentLanguage === 'es' ? 
                '¬øEst√°s seguro de cerrar sesi√≥n?' : 
                'Are you sure you want to logout?')) {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('driver-app').style.display = 'none';
                document.getElementById('login-form').reset();
            }
        }

        function showUserProfile() {
            // Abrir modal de edici√≥n de perfil
            document.getElementById('profile-modal').classList.add('active');
            
            // Llenar formulario con datos actuales
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            
            // Mostrar rol y estado (solo lectura)
            const roleText = currentUser.role === 'admin' ? (currentLanguage === 'es' ? 'Administrador' : 'Administrator') :
                            currentUser.role === 'user' ? (currentLanguage === 'es' ? 'Usuario' : 'User') :
                            (currentLanguage === 'es' ? 'Chofer' : 'Driver');
            const statusText = currentUser.status === 'active' ? (currentLanguage === 'es' ? 'Activo' : 'Active') :
                              (currentLanguage === 'es' ? 'Inactivo' : 'Inactive');
            
            document.getElementById('profile-role-value').innerHTML = `<span class="badge badge-primary">${roleText}</span>`;
            document.getElementById('profile-status-value').innerHTML = `<span class="badge badge-${currentUser.status === 'active' ? 'success' : 'danger'}">${statusText}</span>`;
            
            // Limpiar campos de contrase√±a
            document.getElementById('profile-current-password').value = '';
            document.getElementById('profile-new-password').value = '';
            document.getElementById('profile-confirm-password').value = '';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function saveProfile(event) {
            event.preventDefault();
            
            const newName = document.getElementById('profile-name').value;
            const newUsername = document.getElementById('profile-username').value;
            const newEmail = document.getElementById('profile-email').value;
            const newPhone = document.getElementById('profile-phone').value;
            
            const currentPassword = document.getElementById('profile-current-password').value;
            const newPassword = document.getElementById('profile-new-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;
            
            // Verificar si se est√° cambiando el username
            const users = db.getUsers();
            if (newUsername !== currentUser.username) {
                // Verificar que el nuevo username no exista
                const usernameExists = users.some(u => u.username === newUsername && u.id !== currentUser.id);
                if (usernameExists) {
                    alert(currentLanguage === 'es' ? 
                        '‚ùå El nombre de usuario ya est√° en uso' : 
                        '‚ùå Username already exists');
                    return;
                }
            }
            
            // Si se quiere cambiar contrase√±a
            if (currentPassword || newPassword || confirmPassword) {
                // Validar contrase√±a actual
                if (currentPassword !== currentUser.password) {
                    alert(currentLanguage === 'es' ? 
                        '‚ùå La contrase√±a actual es incorrecta' : 
                        '‚ùå Current password is incorrect');
                    return;
                }
                
                // Validar que las nuevas contrase√±as coincidan
                if (newPassword !== confirmPassword) {
                    alert(currentLanguage === 'es' ? 
                        '‚ùå Las nuevas contrase√±as no coinciden' : 
                        '‚ùå New passwords do not match');
                    return;
                }
                
                // Validar que la nueva contrase√±a no est√© vac√≠a
                if (!newPassword) {
                    alert(currentLanguage === 'es' ? 
                        '‚ùå La nueva contrase√±a no puede estar vac√≠a' : 
                        '‚ùå New password cannot be empty');
                    return;
                }
            }
            
            // Preparar datos para actualizar
            const updateData = {
                name: newName,
                username: newUsername,
                email: newEmail,
                phone: newPhone
            };
            
            // Si se proporcion√≥ nueva contrase√±a, incluirla
            if (newPassword) {
                updateData.password = newPassword;
            }
            
            // Actualizar en base de datos
            db.updateUser(currentUser.id, updateData);
            
            // Actualizar currentUser
            currentUser.name = newName;
            currentUser.username = newUsername;
            currentUser.email = newEmail;
            currentUser.phone = newPhone;
            if (newPassword) {
                currentUser.password = newPassword;
            }
            
            // Actualizar sessionStorage
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Actualizar UI
            document.getElementById('user-name').textContent = currentUser.name;
            
            // Cerrar modal
            closeProfileModal();
            
            alert(currentLanguage === 'es' ? 
                '‚úÖ Perfil actualizado correctamente' : 
                '‚úÖ Profile updated successfully');
        }

        // Driver Interface Functions
        let selectedFile = null;

        function toggleBOLFields() {
            const docType = document.getElementById('driver-doc-type').value;
            const bolFields = document.getElementById('bol-fields');
            
            if (docType === 'bill') {
                bolFields.style.display = 'block';
            } else {
                bolFields.style.display = 'none';
            }
        }

        function loadDriverInterface() {
            // Mostrar interfaz de chofer en lugar del sistema completo
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('driver-app').style.display = 'block';
            
            // Cargar informaci√≥n del chofer
            document.getElementById('driver-name').textContent = currentUser.name;
            
            // Buscar informaci√≥n del chofer en la base de datos
            loadDriverInfo();
            loadDriverDocuments();
            loadDriverReceivedDocuments();
            loadDriverTrips();
        }

        function loadDriverInfo() {
            const drivers = db.getDrivers();
            const driverData = drivers.find(d => d.name === currentUser.name || d.email === currentUser.email);
            
            const infoContent = document.getElementById('driver-info-content');
            
            if (driverData) {
                infoContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; padding: 10px; background: var(--light-bg); border-radius: 8px;">
                        <strong>Nombre:</strong>
                        <span>${driverData.name}</span>
                        
                        <strong>Tel√©fono:</strong>
                        <span>${driverData.phone || 'N/A'}</span>
                        
                        <strong>Email:</strong>
                        <span>${driverData.email || 'N/A'}</span>
                        
                        <strong>Licencia:</strong>
                        <span>${driverData.licenseNumber || 'N/A'}</span>
                        
                        <strong>Estado:</strong>
                        <span class="badge badge-${driverData.status === 'active' ? 'success' : 'danger'}">
                            ${driverData.status === 'active' ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                `;
            } else {
                infoContent.innerHTML = `
                    <div style="padding: 10px; background: var(--light-bg); border-radius: 8px;">
                        <p><strong>Nombre:</strong> ${currentUser.name}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p style="color: var(--text-light); font-size: 14px; margin-top: 10px;">
                            ‚ÑπÔ∏è Contacta al administrador para completar tu informaci√≥n
                        </p>
                    </div>
                `;
            }
        }

        function openCamera() {
            document.getElementById('driver-camera-input').click();
        }

        function selectFile() {
            document.getElementById('driver-file-input').click();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para c√°mara
            const cameraInput = document.getElementById('driver-camera-input');
            if (cameraInput) {
                cameraInput.addEventListener('change', handleFileSelect);
            }
            
            // Event listener para archivo
            const fileInput = document.getElementById('driver-file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                
                // Mostrar vista previa
                const preview = document.getElementById('driver-preview');
                const previewImg = document.getElementById('driver-preview-img');
                const previewName = document.getElementById('driver-preview-name');
                
                preview.style.display = 'block';
                previewName.textContent = file.name;
                
                // Si es imagen, mostrar preview
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Si es PDF, mostrar √≠cono
                    previewImg.style.display = 'none';
                }
            }
        }

        function clearPreview() {
            selectedFile = null;
            document.getElementById('driver-preview').style.display = 'none';
            document.getElementById('driver-preview-img').src = '';
            document.getElementById('driver-camera-input').value = '';
            document.getElementById('driver-file-input').value = '';
        }

        function uploadDriverDocument() {
            const docType = document.getElementById('driver-doc-type').value;
            const docName = document.getElementById('driver-doc-name').value;
            
            if (!docType) {
                alert(currentLanguage === 'es' ? 
                    'Por favor selecciona el tipo de documento' : 
                    'Please select document type');
                return;
            }
            
            // Validar campos de BOL si es necesario
            if (docType === 'bill') {
                const origin = document.getElementById('bol-origin').value;
                const destination = document.getElementById('bol-destination').value;
                
                if (!origin || !destination) {
                    alert(currentLanguage === 'es' ? 
                        'Por favor completa Origen y Destino para el BOL' : 
                        'Please complete Origin and Destination for BOL');
                    return;
                }
            }
            
            if (!selectedFile) {
                alert(currentLanguage === 'es' ? 
                    'Por favor toma una foto o selecciona un archivo' : 
                    'Please take a photo or select a file');
                return;
            }
            
            // Buscar informaci√≥n del chofer y su cami√≥n asignado
            const drivers = db.getDrivers();
            const driverData = drivers.find(d => d.name === currentUser.name || d.email === currentUser.email);
            
            // Buscar asignaci√≥n actual del chofer
            const assignments = db.getAssignments();
            const currentAssignment = assignments.find(a => 
                a.driverId === (driverData ? driverData.id : currentUser.id) && 
                a.status === 'active'
            );
            
            // Obtener informaci√≥n del cami√≥n
            let truckNumber = 'Sin asignar';
            if (currentAssignment) {
                const trucks = db.getTrucks();
                const truck = trucks.find(t => t.id === currentAssignment.truckId);
                if (truck) {
                    truckNumber = truck.unitNumber || truck.plate || `Truck #${truck.id}`;
                }
            }
            
            // Crear documento con toda la informaci√≥n
            const currentDate = new Date();
            const dateString = currentDate.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            const newDocument = {
                type: 'driver',
                entityId: driverData ? driverData.id : currentUser.id,
                entityName: currentUser.name,
                category: docType,
                fileName: selectedFile.name,
                uploadDate: currentDate.toISOString(),
                status: 'pending',
                notes: docName || `${docType} - ${currentUser.name}`,
                uploadedBy: currentUser.name,
                driverName: currentUser.name,
                truckNumber: truckNumber,
                uploadDateFormatted: dateString,
                documentDescription: `${docType} | Chofer: ${currentUser.name} | Cami√≥n: ${truckNumber} | Fecha: ${dateString}`
            };
            
            // Agregar campos espec√≠ficos de BOL
            if (docType === 'bill') {
                newDocument.bolOrigin = document.getElementById('bol-origin').value;
                newDocument.bolDestination = document.getElementById('bol-destination').value;
                newDocument.bolNumber = document.getElementById('bol-number').value || '';
                newDocument.bolCargo = document.getElementById('bol-cargo').value || '';
                newDocument.documentDescription = `BOL: ${newDocument.bolOrigin} ‚Üí ${newDocument.bolDestination} | Chofer: ${currentUser.name} | Cami√≥n: ${truckNumber}`;
            }
            
            db.saveDocument(newDocument);
            
            let alertMessage = '';
            if (docType === 'bill') {
                alertMessage = currentLanguage === 'es' ? 
                    `‚úÖ BOL enviado:\n\nüìÑ Tipo: Bill of Lading\nüìç Origen: ${newDocument.bolOrigin}\nüìç Destino: ${newDocument.bolDestination}\nüë§ Chofer: ${currentUser.name}\nüöõ Cami√≥n: ${truckNumber}\nüìÖ Fecha: ${dateString}\n\n‚è≥ Estado: Pendiente` :
                    `‚úÖ BOL sent:\n\nüìÑ Type: Bill of Lading\nüìç Origin: ${newDocument.bolOrigin}\nüìç Destination: ${newDocument.bolDestination}\nüë§ Driver: ${currentUser.name}\nüöõ Truck: ${truckNumber}\nüìÖ Date: ${dateString}\n\n‚è≥ Status: Pending`;
            } else {
                alertMessage = currentLanguage === 'es' ? 
                    `‚úÖ Documento enviado:\n\nüìÑ Tipo: ${docType}\nüë§ Chofer: ${currentUser.name}\nüöõ Cami√≥n: ${truckNumber}\nüìÖ Fecha: ${dateString}\n\n‚è≥ Estado: Pendiente` :
                    `‚úÖ Document sent:\n\nüìÑ Type: ${docType}\nüë§ Driver: ${currentUser.name}\nüöõ Truck: ${truckNumber}\nüìÖ Date: ${dateString}\n\n‚è≥ Status: Pending`;
            }
            
            alert(alertMessage);
            
            // Limpiar formulario
            document.getElementById('driver-doc-type').value = '';
            document.getElementById('driver-doc-name').value = '';
            if (docType === 'bill') {
                document.getElementById('bol-origin').value = '';
                document.getElementById('bol-destination').value = '';
                document.getElementById('bol-number').value = '';
                document.getElementById('bol-cargo').value = '';
                document.getElementById('bol-fields').style.display = 'none';
            }
            clearPreview();
            
            // Recargar lista de documentos
            loadDriverDocuments();
        }

        function loadDriverDocuments() {
            const documents = db.getDocuments().filter(d => d.entityName === currentUser.name);
            const listContainer = document.getElementById('driver-documents-list');
            
            if (documents.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p style="font-size: 48px; margin: 0;">üì≠</p>
                        <p style="margin: 10px 0 0 0;">No has subido documentos a√∫n</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar por fecha m√°s reciente
            documents.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
            
            listContainer.innerHTML = documents.map(doc => {
                const date = doc.uploadDateFormatted || new Date(doc.uploadDate).toLocaleDateString('es-ES');
                const statusBadge = doc.status === 'approved' ? 'success' : 
                                   doc.status === 'rejected' ? 'danger' : 
                                   doc.status === 'received' ? 'info' : 'warning';
                const statusText = doc.status === 'approved' ? '‚úÖ Aprobado' : 
                                  doc.status === 'rejected' ? '‚ùå Rechazado' : 
                                  doc.status === 'received' ? 'üì• Recibido' : '‚è≥ Pendiente';
                
                const categoryIcon = doc.category === 'factura' ? 'üìÑ' :
                                    doc.category === 'bill' ? 'üßæ' :
                                    doc.category === 'recibo' ? 'üßæ' :
                                    doc.category === 'licencia' ? 'üöó' :
                                    doc.category === 'medico' ? 'üè•' : 'üìã';
                
                const categoryText = doc.category === 'factura' ? 'Factura' :
                                    doc.category === 'bill' ? 'Bill of Lading' :
                                    doc.category === 'recibo' ? 'Recibo' :
                                    doc.category === 'licencia' ? 'Licencia' :
                                    doc.category === 'medico' ? 'Certificado M√©dico' : 'Documento';
                
                // Mostrar informaci√≥n espec√≠fica de BOL si aplica
                let bolInfo = '';
                if (doc.category === 'bill' && doc.bolOrigin && doc.bolDestination) {
                    bolInfo = `
                        <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: #1e40af;">üìç Ruta del Viaje:</div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <span style="color: #059669;">üü¢ Origen:</span>
                                <strong>${doc.bolOrigin}</strong>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <span style="color: #dc2626;">üî¥ Destino:</span>
                                <strong>${doc.bolDestination}</strong>
                            </div>
                            ${doc.bolNumber ? `<div style="margin-top: 5px;"><strong>üìã BOL #:</strong> ${doc.bolNumber}</div>` : ''}
                            ${doc.bolCargo ? `<div style="margin-top: 5px;"><strong>üì¶ Carga:</strong> ${doc.bolCargo}</div>` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-size: 20px; margin-bottom: 5px;">${categoryIcon}</div>
                                <strong style="font-size: 16px;">${categoryText}</strong>
                                ${doc.notes ? `<div style="font-size: 14px; color: var(--text-light); margin-top: 3px;">${doc.notes}</div>` : ''}
                            </div>
                            <span class="badge badge-${statusBadge}">${statusText}</span>
                        </div>
                        ${bolInfo}
                        <div style="font-size: 14px; color: var(--text-dark); background: var(--light-bg); padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <div style="margin-bottom: 5px;"><strong>üë§ Chofer:</strong> ${doc.driverName || doc.entityName}</div>
                            <div style="margin-bottom: 5px;"><strong>üöõ Cami√≥n:</strong> ${doc.truckNumber || 'No disponible'}</div>
                            <div style="margin-bottom: 5px;"><strong>üìÖ Fecha:</strong> ${date}</div>
                            <div><strong>üìé Archivo:</strong> ${doc.fileName}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadDriverReceivedDocuments() {
            // Aqu√≠ cargamos documentos que el admin ha enviado al chofer
            // Por ahora mostraremos los documentos aprobados/recibidos como ejemplo
            const allDocuments = db.getDocuments();
            const receivedDocs = allDocuments.filter(d => 
                d.sentToDriver === currentUser.name || 
                (d.type === 'admin' && d.targetDriver === currentUser.name)
            );
            
            const listContainer = document.getElementById('driver-received-documents-list');
            
            if (receivedDocs.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p style="font-size: 48px; margin: 0;">üì™</p>
                        <p style="margin: 10px 0 0 0;">No tienes documentos recibidos</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = receivedDocs.map(doc => {
                const date = doc.uploadDateFormatted || new Date(doc.uploadDate).toLocaleDateString('es-ES');
                
                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f0fdf4;">
                        <div style="display: flex; align-items: start; gap: 10px; margin-bottom: 10px;">
                            <div style="font-size: 32px;">üì¨</div>
                            <div style="flex: 1;">
                                <strong style="font-size: 16px;">${doc.fileName || doc.notes || 'Documento'}</strong>
                                <div style="font-size: 14px; color: var(--text-light); margin-top: 3px;">
                                    Enviado por: Administrador
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 14px; background: white; padding: 10px; border-radius: 6px;">
                            <div><strong>üìÖ Fecha:</strong> ${date}</div>
                            ${doc.notes ? `<div style="margin-top: 5px;"><strong>üìù Nota:</strong> ${doc.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadDriverTrips() {
            const drivers = db.getDrivers();
            const driverData = drivers.find(d => d.name === currentUser.name || d.email === currentUser.email);
            
            // Obtener viajes de la secci√≥n de Viajes (no asignaciones)
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const driverTrips = trips.filter(t => 
                t.driverId === (driverData ? driverData.id : currentUser.id)
            );
            
            const listContainer = document.getElementById('driver-trips-list');
            
            // Calcular millas totales
            let totalMiles = 0;
            driverTrips.forEach(trip => {
                if (trip.status === 'completed' && trip.distance) {
                    const miles = parseFloat(trip.distance.replace(/[^0-9.]/g, ''));
                    if (!isNaN(miles)) totalMiles += miles;
                }
            });
            
            if (driverTrips.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <p style="font-size: 48px; margin: 0;">üöõ</p>
                        <p style="margin: 10px 0 0 0;">No tienes viajes asignados</p>
                    </div>
                `;
                return;
            }
            
            // Mostrar contador de millas totales arriba
            let html = `
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìä MILLAS TOTALES RECORRIDAS</div>
                        <div style="font-size: 36px; font-weight: bold;">${totalMiles.toLocaleString()} mi</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${driverTrips.filter(t => t.status === 'completed').length} viajes completados</div>
                    </div>
                </div>
            `;
            
            // Separar viajes por estado
            const pendingTrips = driverTrips.filter(t => t.status === 'pending');
            const inProgressTrips = driverTrips.filter(t => t.status === 'in-progress');
            const completedTrips = driverTrips.filter(t => t.status === 'completed');
            
            // Mostrar viajes en progreso primero
            if (inProgressTrips.length > 0) {
                html += '<div style="font-weight: 600; color: #2563eb; margin: 20px 0 10px 0; font-size: 16px;">üöö EN RUTA</div>';
                html += inProgressTrips.map(trip => renderDriverTrip(trip)).join('');
            }
            
            // Luego pendientes
            if (pendingTrips.length > 0) {
                html += '<div style="font-weight: 600; color: #f59e0b; margin: 20px 0 10px 0; font-size: 16px;">‚è≥ PENDIENTES</div>';
                html += pendingTrips.map(trip => renderDriverTrip(trip)).join('');
            }
            
            // Finalmente completados
            if (completedTrips.length > 0) {
                html += '<div style="font-weight: 600; color: #10b981; margin: 20px 0 10px 0; font-size: 16px;">‚úÖ COMPLETADOS</div>';
                html += completedTrips.map(trip => renderDriverTrip(trip)).join('');
            }
            
            listContainer.innerHTML = html;
        }
        
        function renderDriverTrip(trip) {
            const statusColors = {
                'pending': {bg: '#fef3c7', border: '#f59e0b', badge: 'warning', text: '‚è≥ Pendiente'},
                'in-progress': {bg: '#dbeafe', border: '#2563eb', badge: 'info', text: 'üöö En Ruta'},
                'completed': {bg: '#d1fae5', border: '#10b981', badge: 'success', text: '‚úÖ Completado'}
            };
            
            const style = statusColors[trip.status] || statusColors['pending'];
            const startDate = trip.startDate ? new Date(trip.startDate).toLocaleDateString('es-ES') : 'N/A';
            
            return `
                <div style="border: 2px solid ${style.border}; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: ${style.bg};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <strong style="font-size: 18px;">üì¶ ${trip.document}</strong>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 3px;">Viaje #${trip.id}</div>
                        </div>
                        <span class="badge badge-${style.badge}" style="font-size: 14px;">${style.text}</span>
                    </div>
                    
                    <!-- Direcci√≥n de Recogida -->
                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">üìç DIRECCI√ìN DE RECOGIDA</div>
                        <div style="font-weight: 600; color: #059669;">${trip.pickupAddress}</div>
                        <div style="font-size: 14px; color: #6b7280; margin-top: 3px;">${trip.pickupCity}</div>
                    </div>
                    
                    <!-- Ruta -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 11px; color: #6b7280;">Origen</div>
                                <strong style="color: #059669;">${trip.pickupCity}</strong>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: white; padding: 4px 12px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <strong style="color: #2563eb; font-size: 16px;">${trip.distance}</strong>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #6b7280;">Destino</div>
                                <strong style="color: #dc2626;">${trip.destinationCity}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Documento adjunto si existe -->
                    ${trip.hasFile ? `
                        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üìÑ</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: var(--text-light);">Documento Adjunto</div>
                                    <strong style="font-size: 14px;">${trip.fileName}</strong>
                                </div>
                                <button onclick="viewTripDocument(${trip.id})" class="btn btn-primary btn-sm">üëÅÔ∏è Ver</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Info adicional -->
                    <div style="background: white; padding: 10px; border-radius: 8px; font-size: 13px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><strong>üìÖ</strong> ${startDate}</div>
                            ${trip.notes ? `<div style="grid-column: 1 / -1;"><strong>üìù</strong> ${trip.notes}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function viewTripDocument(tripId) {
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const trip = trips.find(t => t.id === tripId);
            
            if (trip && trip.fileData) {
                // Abrir en nueva ventana
                const win = window.open();
                if (trip.fileName.toLowerCase().endsWith('.pdf')) {
                    win.document.write(`<iframe src="${trip.fileData}" style="width:100%;height:100%;border:none;"></iframe>`);
                } else {
                    win.document.write(`<img src="${trip.fileData}" style="max-width:100%;height:auto;">`);
                }
            } else {
                alert('Documento no disponible');
            }
        }

        // ==================== ACCOUNTING FUNCTIONS ====================

        // --- INVOICES ---
        function openInvoiceModal() {
            document.getElementById('invoice-modal').classList.add('active');
            document.getElementById('invoice-form').reset();
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inv-date').value = today;
            // Set due date 30 days from now
            const due = new Date(); due.setDate(due.getDate() + 30);
            document.getElementById('inv-due-date').value = due.toISOString().split('T')[0];
            // Auto-generate invoice number
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const nextNum = (invoices.length + 1).toString().padStart(4, '0');
            document.getElementById('inv-number').value = `INV-${nextNum}`;
            // Load trips
            const trips = JSON.parse(localStorage.getItem('trips') || '[]');
            const select = document.getElementById('inv-trip');
            select.innerHTML = '<option value="">Sin viaje espec√≠fico</option>';
            trips.forEach(t => {
                select.innerHTML += `<option value="${t.id}">${t.document} | ${t.pickupCity} ‚Üí ${t.destinationCity}</option>`;
            });
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').classList.remove('active');
        }

        function saveInvoice(event) {
            event.preventDefault();
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const invoice = {
                id: Date.now(),
                number: document.getElementById('inv-number').value,
                client: document.getElementById('inv-client').value,
                type: document.getElementById('inv-type').value,
                tripId: document.getElementById('inv-trip').value || null,
                date: document.getElementById('inv-date').value,
                dueDate: document.getElementById('inv-due-date').value,
                amount: parseFloat(document.getElementById('inv-amount').value),
                description: document.getElementById('inv-description').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            closeInvoiceModal();
            loadInvoices();
            alert(`‚úÖ Factura ${invoice.number} creada\nüí∞ Monto: $${invoice.amount.toFixed(2)}\nüë§ Cliente: ${invoice.client}`);
        }

        function loadInvoices(filter = 'all') {
            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const today = new Date().toISOString().split('T')[0];

            // Update overdue status
            invoices = invoices.map(inv => {
                if (inv.status === 'pending' && inv.dueDate < today) inv.status = 'overdue';
                return inv;
            });
            localStorage.setItem('invoices', JSON.stringify(invoices));

            // Totals
            const paid = invoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.amount, 0);
            const pending = invoices.filter(i => i.status === 'pending').reduce((s, i) => s + i.amount, 0);
            const overdue = invoices.filter(i => i.status === 'overdue').reduce((s, i) => s + i.amount, 0);
            const total = invoices.reduce((s, i) => s + i.amount, 0);

            document.getElementById('inv-paid').textContent = `$${paid.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('inv-pending').textContent = `$${pending.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('inv-overdue').textContent = `$${overdue.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('inv-total').textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits:2})}`;

            // Filter
            const filtered = filter === 'all' ? invoices : invoices.filter(i => i.status === filter);
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const tbody = document.getElementById('invoices-tbody');
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:#6b7280;">No hay facturas</td></tr>`;
                return;
            }

            const statusStyles = {
                paid: {color:'#10b981', bg:'#d1fae5', text:'‚úÖ Cobrada'},
                pending: {color:'#f59e0b', bg:'#fef3c7', text:'‚è≥ Pendiente'},
                overdue: {color:'#ef4444', bg:'#fee2e2', text:'üö® Vencida'}
            };

            tbody.innerHTML = filtered.map(inv => {
                const s = statusStyles[inv.status] || statusStyles.pending;
                const typeText = inv.type === 'trip' ? 'üöö Viaje' : inv.type === 'monthly' ? 'üìÖ Mensual' : 'üì¶ Otro';
                return `
                    <tr>
                        <td><strong>${inv.number}</strong></td>
                        <td>${inv.client}</td>
                        <td>${typeText}</td>
                        <td>${inv.date}</td>
                        <td>${inv.dueDate}</td>
                        <td><strong style="color:#10b981;">$${inv.amount.toLocaleString('en-US', {minimumFractionDigits:2})}</strong></td>
                        <td><span style="padding:4px 10px;border-radius:20px;background:${s.bg};color:${s.color};font-size:12px;font-weight:600;">${s.text}</span></td>
                        <td>
                            ${inv.status !== 'paid' ? `<button class="btn btn-success btn-sm" onclick="markInvoicePaid(${inv.id})">üí∞ Cobrar</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${inv.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterInvoices(filter) {
            document.querySelectorAll('[id^="inv-tab-"]').forEach(t => t.classList.remove('active'));
            document.getElementById(`inv-tab-${filter}`).classList.add('active');
            loadInvoices(filter);
        }

        function markInvoicePaid(id) {
            if (!confirm('¬øMarcar esta factura como cobrada?')) return;
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const inv = invoices.find(i => i.id === id);
            if (inv) {
                inv.status = 'paid';
                inv.paidDate = new Date().toISOString().split('T')[0];
                localStorage.setItem('invoices', JSON.stringify(invoices));
                loadInvoices();
                alert(`‚úÖ Factura ${inv.number} marcada como cobrada\nüí∞ $${inv.amount.toFixed(2)} recibido de ${inv.client}`);
            }
        }

        function deleteInvoice(id) {
            if (!confirm('¬øEliminar esta factura?')) return;
            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices = invoices.filter(i => i.id !== id);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            loadInvoices();
        }

        // --- EXPENSES ---
        function openExpenseModal() {
            document.getElementById('expense-modal').classList.add('active');
            document.getElementById('expense-form').reset();
            document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];
            // Load trucks and drivers
            const trucks = db.getTrucks();
            const drivers = db.getDrivers();
            const truckSel = document.getElementById('exp-truck');
            const driverSel = document.getElementById('exp-driver');
            truckSel.innerHTML = '<option value="">General / No aplica</option>';
            driverSel.innerHTML = '<option value="">General / No aplica</option>';
            trucks.forEach(t => truckSel.innerHTML += `<option value="${t.id}">${t.unitNumber || t.plate}</option>`);
            drivers.forEach(d => driverSel.innerHTML += `<option value="${d.id}">${d.firstName} ${d.lastName}</option>`);
        }

        function closeExpenseModal() {
            document.getElementById('expense-modal').classList.remove('active');
        }

        function saveExpense(event) {
            event.preventDefault();
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const catMap = {fuel:'‚õΩ Combustible', repair:'üîß Reparaciones', salary:'üë§ Salario', insurance:'üõ°Ô∏è Seguro', tolls:'üõ£Ô∏è Peajes', permits:'üìÑ Permisos', other:'üì¶ Otro'};
            const expense = {
                id: Date.now(),
                category: document.getElementById('exp-category').value,
                categoryText: catMap[document.getElementById('exp-category').value] || 'Otro',
                date: document.getElementById('exp-date').value,
                amount: parseFloat(document.getElementById('exp-amount').value),
                truckId: document.getElementById('exp-truck').value || null,
                driverId: document.getElementById('exp-driver').value || null,
                description: document.getElementById('exp-description').value,
                createdAt: new Date().toISOString()
            };
            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            closeExpenseModal();
            loadExpenses();
            alert(`‚úÖ Gasto registrado\n${expense.categoryText}\nüí∏ $${expense.amount.toFixed(2)}`);
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const thisYear = `${now.getFullYear()}`;

            const monthTotal = expenses.filter(e => e.date.startsWith(thisMonth)).reduce((s,e) => s+e.amount, 0);
            const yearTotal = expenses.filter(e => e.date.startsWith(thisYear)).reduce((s,e) => s+e.amount, 0);
            const total = expenses.reduce((s,e) => s+e.amount, 0);

            document.getElementById('exp-month').textContent = `$${monthTotal.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('exp-year').textContent = `$${yearTotal.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('exp-total').textContent = `$${total.toLocaleString('en-US', {minimumFractionDigits:2})}`;

            const trucks = db.getTrucks();
            const drivers = db.getDrivers();
            expenses.sort((a,b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('expenses-tbody');
            if (expenses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:#6b7280;">No hay gastos registrados</td></tr>`;
                return;
            }

            tbody.innerHTML = expenses.map(exp => {
                const truck = exp.truckId ? trucks.find(t => t.id == exp.truckId) : null;
                const driver = exp.driverId ? drivers.find(d => d.id == exp.driverId) : null;
                const entity = truck ? `üöõ ${truck.unitNumber || truck.plate}` : driver ? `üë§ ${driver.firstName} ${driver.lastName}` : 'General';
                return `
                    <tr>
                        <td>${exp.date}</td>
                        <td><span style="padding:4px 10px;border-radius:20px;background:#f3f4f6;font-size:12px;">${exp.categoryText}</span></td>
                        <td>${exp.description}</td>
                        <td>${entity}</td>
                        <td><strong style="color:#ef4444;">$${exp.amount.toLocaleString('en-US', {minimumFractionDigits:2})}</strong></td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteExpense(${exp.id})">üóëÔ∏è</button></td>
                    </tr>
                `;
            }).join('');
        }

        function deleteExpense(id) {
            if (!confirm('¬øEliminar este gasto?')) return;
            let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            loadExpenses();
        }

        // --- ACCOUNTING DASHBOARD ---
        function loadAccounting() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');

            const income = invoices.filter(i => i.status === 'paid').reduce((s,i) => s+i.amount, 0);
            const totalExpenses = expenses.reduce((s,e) => s+e.amount, 0);
            const balance = income - totalExpenses;

            document.getElementById('acc-income').textContent = `$${income.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('acc-expenses').textContent = `$${totalExpenses.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('acc-balance').textContent = `$${Math.abs(balance).toLocaleString('en-US', {minimumFractionDigits:2})}`;

            const balanceCard = document.getElementById('acc-balance-card');
            if (balance >= 0) {
                balanceCard.style.background = 'linear-gradient(135deg,#10b981,#059669)';
                balanceCard.style.color = 'white';
                balanceCard.style.border = 'none';
                document.getElementById('acc-balance').textContent = `+$${balance.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            } else {
                balanceCard.style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
                balanceCard.style.color = 'white';
                balanceCard.style.border = 'none';
                document.getElementById('acc-balance').textContent = `-$${Math.abs(balance).toLocaleString('en-US', {minimumFractionDigits:2})}`;
            }

            // Expenses by category
            const catTotals = {};
            expenses.forEach(e => {
                catTotals[e.categoryText] = (catTotals[e.categoryText] || 0) + e.amount;
            });

            const catDiv = document.getElementById('expenses-by-category');
            if (Object.keys(catTotals).length === 0) {
                catDiv.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No hay gastos registrados</p>';
            } else {
                catDiv.innerHTML = Object.entries(catTotals)
                    .sort((a,b) => b[1]-a[1])
                    .map(([cat, total]) => {
                        const pct = totalExpenses > 0 ? (total/totalExpenses*100).toFixed(0) : 0;
                        return `
                            <div style="margin-bottom:12px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                                    <span style="font-size:14px;">${cat}</span>
                                    <strong>$${total.toLocaleString('en-US', {minimumFractionDigits:2})}</strong>
                                </div>
                                <div style="background:#e5e7eb;border-radius:8px;height:8px;">
                                    <div style="background:var(--primary-color);height:100%;width:${pct}%;border-radius:8px;transition:width 0.5s;"></div>
                                </div>
                                <div style="font-size:11px;color:#6b7280;text-align:right;">${pct}%</div>
                            </div>
                        `;
                    }).join('');
            }

            // Recent invoices
            const recentDiv = document.getElementById('recent-invoices-list');
            const recent = invoices.sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
            if (recent.length === 0) {
                recentDiv.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px;">No hay facturas</p>';
            } else {
                const statusColors = {paid:'#10b981', pending:'#f59e0b', overdue:'#ef4444'};
                recentDiv.innerHTML = recent.map(inv => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:8px;">
                        <div>
                            <strong style="font-size:14px;">${inv.number}</strong>
                            <div style="font-size:12px;color:#6b7280;">${inv.client}</div>
                        </div>
                        <div style="text-align:right;">
                            <strong style="color:${statusColors[inv.status]};">$${inv.amount.toLocaleString('en-US', {minimumFractionDigits:2})}</strong>
                            <div style="font-size:11px;color:${statusColors[inv.status]};">${inv.status === 'paid' ? '‚úÖ Cobrada' : inv.status === 'overdue' ? 'üö® Vencida' : '‚è≥ Pendiente'}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function exportAccounting() {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const income = invoices.filter(i => i.status === 'paid').reduce((s,i) => s+i.amount, 0);
            const totalExp = expenses.reduce((s,e) => s+e.amount, 0);

            let csv = 'REPORTE DE CONTABILIDAD\n\n';
            csv += `INGRESOS TOTALES,$${income.toFixed(2)}\n`;
            csv += `GASTOS TOTALES,$${totalExp.toFixed(2)}\n`;
            csv += `BALANCE NETO,$${(income-totalExp).toFixed(2)}\n\n`;
            csv += 'FACTURAS\n# Factura,Cliente,Monto,Estado,Fecha\n';
            invoices.forEach(i => csv += `${i.number},${i.client},$${i.amount.toFixed(2)},${i.status},${i.date}\n`);
            csv += '\nGASTOS\nFecha,Categoria,Descripcion,Monto\n';
            expenses.forEach(e => csv += `${e.date},${e.categoryText},${e.description},$${e.amount.toFixed(2)}\n`);

            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contabilidad_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function calculateDistance(origin, destination) {
            // Funci√≥n simple para calcular/estimar distancia
            // En producci√≥n, usar Google Maps API o similar
            if (!origin || !destination || origin === 'No especificado' || destination === 'No especificado') {
                return 'N/A';
            }
            
            // Por ahora retornamos un estimado basado en ciudades comunes
            const distances = {
                'Los Angeles-Dallas': '1,435 mi',
                'Dallas-Los Angeles': '1,435 mi',
                'New York-Miami': '1,280 mi',
                'Miami-New York': '1,280 mi',
                'Chicago-Houston': '1,080 mi',
                'Houston-Chicago': '1,080 mi'
            };
            
            const key = `${origin}-${destination}`;
            return distances[key] || 'Calcular ruta';
        }

        // Cerrar modales al hacer click fuera
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Cerrar modales con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                const modals = document.querySelectorAll('.modal.active');
                if (modals.length > 0) {
                    // Cerrar el √∫ltimo modal abierto
                    const lastModal = modals[modals.length - 1];
                    lastModal.classList.remove('active');
                }
            }
        });
    </script>
</body>
</html>
